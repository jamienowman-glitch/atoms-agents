{% comment %}
Red Pen — YouTube Feed (hero + grid, optional on-page demo controls)
{% endcomment %}

<section id="rp-yfeed-{{ section.id }}" class="rp-yfeed"
  style="
    --yf-bg: {{ section.settings.bg }};
    --yf-text: {{ section.settings.text }};
    --yf-accent: {{ section.settings.accent }};
    --yf-gap: {{ section.settings.gap }}px;
    --yf-cols-m: {{ section.settings.cols_mobile }};
    --yf-cols-d: {{ section.settings.cols_desktop }};
    --yf-pad-d: {{ section.settings.pad_desktop }}px;
    --yf-pad-m: {{ section.settings.pad_mobile }}px;
    --yf-title: {{ section.settings.title_size }}px;
    --yf-meta: {{ section.settings.meta_size }}px;
  ">
  <div class="rp-yfeed__inner">
    {% if section.settings.heading != blank %}
      <h2 class="rp-yfeed__heading{% if section.settings.heading_bold %} is-bold{% endif %}">{{ section.settings.heading }}</h2>
    {% endif %}

    <div class="rp-yfeed__hero" aria-live="polite"></div>
    <div class="rp-yfeed__grid" role="list" aria-live="polite"></div>
  </div>

  {% if section.settings.demo_controls %}
  <div class="rp-yfeed__demo">
    <button class="rp-yfeed__demo-toggle" type="button" aria-expanded="false">⚙️ Demo Controls</button>
    <form class="rp-yfeed__demo-panel" hidden>
      <div class="row">
        <label>Background <input type="color" name="bg"></label>
        <label>Text <input type="color" name="text"></label>
        <label>Accent <input type="color" name="accent"></label>
      </div>
      <div class="row">
        <label>Cols (mobile) <input type="number" name="cols_m" min="1" max="6"></label>
        <label>Cols (desktop) <input type="number" name="cols_d" min="1" max="20"></label>
        <label>Gap <input type="number" name="gap" min="0" max="24" step="1"></label>
      </div>
      <div class="row">
        <label>Title size <input type="number" name="title" min="10" max="28" step="1"></label>
        <label>Meta size <input type="number" name="meta" min="8" max="20" step="1"></label>
      </div>
      <div class="row">
        <button type="button" data-action="reset">Reset</button>
      </div>
      <p class="note">Temporary tweaks for preview only. Does not save theme settings.</p>
    </form>
  </div>
  {% endif %}

  <style>
    #rp-yfeed-{{ section.id }}{background:var(--yf-bg);color:var(--yf-text);padding:var(--yf-pad-d) 0;}
    @media(max-width:749px){#rp-yfeed-{{ section.id }}{padding:var(--yf-pad-m) 0;}}
    #rp-yfeed-{{ section.id }} .rp-yfeed__inner{width:min(1200px,94vw);margin:0 auto;}
    #rp-yfeed-{{ section.id }} .rp-yfeed__heading{margin:0 0 12px;letter-spacing:.06em;text-transform:uppercase;font-size:14px;opacity:.9}
    #rp-yfeed-{{ section.id }} .rp-yfeed__heading.is-bold{font-weight:700}

    #rp-yfeed-{{ section.id }} .rp-yfeed__hero{margin:0 0 16px}
    #rp-yfeed-{{ section.id }} .hero-frame{position:relative;background:#000;aspect-ratio:16/9;border:1px solid rgba(0,0,0,.08)}
    #rp-yfeed-{{ section.id }} .hero-frame iframe{width:100%;height:100%;display:block}

    #rp-yfeed-{{ section.id }} .rp-yfeed__grid{
      display:grid; gap:var(--yf-gap);
      grid-template-columns:repeat(var(--yf-cols-d),minmax(0,1fr));
    }
    @media(max-width:749px){
      #rp-yfeed-{{ section.id }} .rp-yfeed__grid{grid-template-columns:repeat(var(--yf-cols-m),minmax(0,1fr));}
    }

    /* Card base */
    #rp-yfeed-{{ section.id }} .card{display:flex;flex-direction:column;background:#fff;color:#111;border:1px solid rgba(0,0,0,.08)}
    #rp-yfeed-{{ section.id }} .thumb{position:relative;background:#f2f2f2;overflow:hidden}
    #rp-yfeed-{{ section.id }} .thumb img{width:100%;height:auto;display:block;object-fit:cover}

    /* Text sizes */
    #rp-yfeed-{{ section.id }} .t{font-size:var(--yf-title);line-height:1.25;margin:6px 8px 2px}
    #rp-yfeed-{{ section.id }} .m{font-size:var(--yf-meta);opacity:.8;margin:0 8px 6px}

    /* CTAs + tiny arrow */
    #rp-yfeed-{{ section.id }} .cta{display:flex;gap:12px;align-items:center;margin:6px 8px 10px}
    #rp-yfeed-{{ section.id }} .cta a{font-size:14px;text-decoration:none;color:var(--yf-accent)}
    #rp-yfeed-{{ section.id }} .cta a:hover{transform:translateX(2px)}
    #rp-yfeed-{{ section.id }} .tiny{margin:6px 0 10px;text-align:center}
    #rp-yfeed-{{ section.id }} .tiny a{font-size:14px;text-decoration:none;color:var(--yf-accent)}

    /* Demo panel */
    #rp-yfeed-{{ section.id }} .rp-yfeed__demo{position:relative;margin:12px 0}
    #rp-yfeed-{{ section.id }} .rp-yfeed__demo-toggle{font-size:12px;opacity:.8;border:1px solid rgba(0,0,0,.15);background:#fff;padding:6px 10px;border-radius:6px;cursor:pointer}
    #rp-yfeed-{{ section.id }} .rp-yfeed__demo-panel{margin-top:8px;padding:10px;border:1px dashed rgba(0,0,0,.2);border-radius:8px;background:#fafafa}
    #rp-yfeed-{{ section.id }} .rp-yfeed__demo-panel .row{display:flex;gap:12px;flex-wrap:wrap;margin:6px 0}
    #rp-yfeed-{{ section.id }} .rp-yfeed__demo-panel label{font-size:12px;display:flex;align-items:center;gap:6px}
    #rp-yfeed-{{ section.id }} .rp-yfeed__demo-panel input[type="number"]{width:70px}
    #rp-yfeed-{{ section.id }} .rp-yfeed__demo-panel .note{font-size:11px;opacity:.7;margin:4px 0 0}
  </style>

  <script>
  (function(){
    var root = document.getElementById('rp-yfeed-{{ section.id }}');
    var hero = root.querySelector('.rp-yfeed__hero');
    var grid = root.querySelector('.rp-yfeed__grid');

    // Settings
    var base      = {{ section.settings.feed_url | json }}; // e.g. https://script.google.com/.../exec  (no query)
    var sort      = {{ section.settings.sort_order | json }}; // newest|views
    var limit     = {{ section.settings.limit | json }};
    var showTitle = {{ section.settings.show_title | json }};
    var showMeta  = {{ section.settings.show_meta  | json }};
    var showCTAs  = {{ section.settings.show_ctas  | json }};
    var showTiny  = {{ section.settings.show_tiny  | json }};
    var openNew   = {{ section.settings.open_new  | json }};

    function buildUrl(){
      try{
        var hasQ = base.indexOf('?') > -1;
        var parts = hasQ ? base.split('?') : [base, ''];
        var path = parts[0] || '/';
        var params = new URLSearchParams(parts[1] || '');
        params.set('action', 'list');
        params.set('sort', sort);
        params.set('limit', String(limit));
        return path + '?' + params.toString();
      }catch(e){ return base || '/'; }
    }
    var url = buildUrl();

    fetch(url)
      .then(async function(r){
        if(!r.ok){
          var txt=''; try{ txt=await r.text(); }catch(_){}
          throw new Error('HTTP '+r.status+' '+r.statusText+' | '+txt.slice(0,180));
        }
        return r.json();
      })
      .then(function(items){
        if(!Array.isArray(items) || !items.length){
          hero.innerHTML = '<div style="opacity:.7;font-size:14px">No videos yet.</div>';
          return;
        }

        // HERO = first item (iframe_html)
        var first = items[0];
        var f = document.createElement('div');
        f.className = 'hero-frame';
        f.innerHTML = first.iframe_html || '';
        hero.appendChild(f);

        // GRID = next N items
        var gridCount = Math.max(0, {{ section.settings.grid_count | json }});
        var rest = items.slice(1, 1 + gridCount);
        var frag = document.createDocumentFragment();

        rest.forEach(function(v){
          var card = document.createElement('article'); card.className='card'; card.setAttribute('role','listitem');

          var linkHref = v.blog_post_url || v.watch_url || '#';
          var linkTarg = openNew ? '_blank' : '_self';

          var a = document.createElement('a'); a.className='thumb'; a.href=linkHref; a.target=linkTarg; a.rel='noopener';
          var img = document.createElement('img'); img.loading='lazy'; img.decoding='async';
          img.alt = v.title || 'Video';
          img.src = v.thumb_url || 'https://dummyimage.com/640x360/eeeeee/aaaaaa.png&text=Video';
          a.appendChild(img); card.appendChild(a);

          if(showTitle){
            var t=document.createElement('div'); t.className='t'; t.textContent=v.title||''; card.appendChild(t);
          }
          if(showMeta){
            var m=document.createElement('div'); m.className='m';
            var when = (v.published_at||'').split('T')[0] || '';
            var ch = v.channel_title || '';
            var vc = (v.view_count!=null) ? (Number(v.view_count).toLocaleString()+' views') : '';
            m.textContent = [when,ch,vc].filter(Boolean).join(' · ');
            card.appendChild(m);
          }
          if(showCTAs){
            var c=document.createElement('div'); c.className='cta';
            if(v.watch_url){ var w=document.createElement('a'); w.href=v.watch_url; w.target=linkTarg; w.rel='noopener'; w.textContent='Watch →'; c.appendChild(w); }
            if(v.blog_post_url){ var b=document.createElement('a'); b.href=v.blog_post_url; b.target=linkTarg; b.rel='noopener'; b.textContent='Read post →'; c.appendChild(b); }
            card.appendChild(c);
          }else if(showTiny){
            var tiny=document.createElement('div'); tiny.className='tiny';
            var ta=document.createElement('a'); ta.href=linkHref; ta.target=linkTarg; ta.rel='noopener'; ta.textContent='→';
            tiny.appendChild(ta); card.appendChild(tiny);
          }

          frag.appendChild(card);
        });

        grid.appendChild(frag);
      })
      .catch(function(err){
        hero.innerHTML = '<div style="opacity:.7;font-size:14px">Couldn’t load videos.</div>';
        if (window.console && console.warn) console.warn('YFeed error:', err);
      });

    /* ---------- Optional demo controls (client-only) ---------- */
    {% if section.settings.demo_controls %}
    (function attachDemoControls(){
      var wrap = root.querySelector('.rp-yfeed__demo');
      if(!wrap) return;
      var btn = wrap.querySelector('.rp-yfeed__demo-toggle');
      var panel = wrap.querySelector('.rp-yfeed__demo-panel');
      var storageKey = 'rp-yfeed-demo-{{ section.id }}';

      function apply(vars){
        if(vars.bg)     root.style.setProperty('--yf-bg', vars.bg);
        if(vars.text)   root.style.setProperty('--yf-text', vars.text);
        if(vars.accent) root.style.setProperty('--yf-accent', vars.accent);
        if(vars.cols_m) root.style.setProperty('--yf-cols-m', vars.cols_m);
        if(vars.cols_d) root.style.setProperty('--yf-cols-d', vars.cols_d);
        if(vars.gap)    root.style.setProperty('--yf-gap', vars.gap+'px');
        if(vars.title)  root.style.setProperty('--yf-title', vars.title+'px');
        if(vars.meta)   root.style.setProperty('--yf-meta', vars.meta+'px');
      }

      // init form values from current CSS/customizer
      var form = panel;
      form.bg.value     = getComputedStyle(root).getPropertyValue('--yf-bg').trim() || '#ffffff';
      form.text.value   = getComputedStyle(root).getPropertyValue('--yf-text').trim() || '#111111';
      form.accent.value = getComputedStyle(root).getPropertyValue('--yf-accent').trim() || '#F50E0E';
      form.cols_m.value = getComputedStyle(root).getPropertyValue('--yf-cols-m').trim() || {{ section.settings.cols_mobile }};
      form.cols_d.value = getComputedStyle(root).getPropertyValue('--yf-cols-d').trim() || {{ section.settings.cols_desktop }};
      form.gap.value    = (getComputedStyle(root).getPropertyValue('--yf-gap').trim() || {{ section.settings.gap }});
      form.title.value  = (getComputedStyle(root).getPropertyValue('--yf-title').trim() || {{ section.settings.title_size }});
      form.meta.value   = (getComputedStyle(root).getPropertyValue('--yf-meta').trim() || {{ section.settings.meta_size }});

      // restore localStorage overrides
      try{
        var saved = JSON.parse(localStorage.getItem(storageKey) || '{}');
        apply(saved);
        Object.keys(saved).forEach(k=>{ if(form[k]) form[k].value = saved[k]; });
      }catch(_){}

      form.addEventListener('input', function(){
        var vars = {
          bg: form.bg.value,
          text: form.text.value,
          accent: form.accent.value,
          cols_m: form.cols_m.value,
          cols_d: form.cols_d.value,
          gap: form.gap.value,
          title: form.title.value,
          meta: form.meta.value
        };
        apply(vars);
        try{ localStorage.setItem(storageKey, JSON.stringify(vars)); }catch(_){}
      });

      form.querySelector('[data-action="reset"]').addEventListener('click', function(){
        try{ localStorage.removeItem(storageKey); }catch(_){}
        location.reload();
      });

      btn.addEventListener('click', function(){
        var expanded = btn.getAttribute('aria-expanded') === 'true';
        btn.setAttribute('aria-expanded', String(!expanded));
        panel.hidden = expanded;
      });
    })();
    {% endif %}
  })();
  </script>
</section>

{% schema %}
{
  "name": "YouTube Feed",
  "settings": [
    { "type":"text","id":"heading","label":"Heading","default":"Now Playing" },
    { "type":"checkbox","id":"heading_bold","label":"Bold heading","default":false },

    { "type":"text","id":"feed_url","label":"Feed base URL (Apps Script web app)", "default": "/" },
    { "type":"select","id":"sort_order","label":"Order", "default":"newest", "options":[
      {"value":"newest","label":"Newest"},
      {"value":"views","label":"Most viewed"}
    ]},
    { "type":"range","id":"limit","label":"Max items to fetch (incl. hero)", "min":4,"max":60,"step":2,"default":12 },
    { "type":"range","id":"grid_count","label":"Grid items under hero", "min":3,"max":24,"step":1,"default":6 },

    { "type":"checkbox","id":"show_title","label":"Show titles","default":true },
    { "type":"checkbox","id":"show_meta","label":"Show meta (date · channel · views)","default":true },
    { "type":"checkbox","id":"show_ctas","label":"Show CTA links","default":true },
    { "type":"checkbox","id":"show_tiny","label":"Show tiny arrow if no CTAs","default":true },
    { "type":"checkbox","id":"open_new","label":"Open links in new tab","default":true },

    { "type":"color","id":"bg","label":"Background","default":"#ffffff" },
    { "type":"color","id":"text","label":"Text","default":"#111111" },
    { "type":"color","id":"accent","label":"Link/Accent","default":"#F50E0E" },

    { "type":"range","id":"title_size","label":"Title size","min":12,"max":24,"step":1,"default":12 },
    { "type":"range","id":"meta_size","label":"Meta size","min":10,"max":18,"step":1,"default":10 },

    { "type":"range","id":"cols_mobile","label":"Columns (mobile)","min":1,"max":6,"step":1,"default":2 },
    { "type":"range","id":"cols_desktop","label":"Columns (desktop)","min":1,"max":20,"step":1,"default":6 },
    { "type":"range","id":"gap","label":"Gap","min":0,"max":24,"step":2,"default":12 },

    { "type":"range","id":"pad_desktop","label":"Padding (desktop)","min":0,"max":120,"step":8,"default":40 },
    { "type":"range","id":"pad_mobile","label":"Padding (mobile)","min":0,"max":80,"step":4,"default":20 },

    { "type":"checkbox","id":"demo_controls","label":"Show on-page demo controls (preview-only)", "default": true }
  ],
  "presets":[{ "name":"YouTube Feed", "category":"Red Pen" }]
}
{% endschema %}