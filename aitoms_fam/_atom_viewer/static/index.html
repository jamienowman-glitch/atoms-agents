<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atom Viewer</title>
    <style>
        body {
            font-family: -apple-system, system-ui, sans-serif;
            margin: 0;
            padding: 0;
            background: #f4f4f4;
            display: flex;
            height: 100vh;
        }

        #sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        #main {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: #fff;
            position: sticky;
            top: 0;
        }

        .atom-item {
            padding: 10px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }

        .atom-item:hover,
        .atom-item.selected {
            background: #eef;
        }

        .atom-item .name {
            font-weight: 500;
            display: block;
        }

        .atom-item .sub {
            font-size: 0.8em;
            color: #666;
            display: flex;
            justify-content: space-between;
            margin-top: 4px;
        }

        .badge {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: bold;
        }

        .badge.PARTIAL {
            background: #ffeeba;
            color: #856404;
        }

        .badge.RENDER_READY {
            background: #d4edda;
            color: #155724;
        }

        .badge.SYSTEM_READY {
            background: #cce5ff;
            color: #004085;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .status-dot.UNREVIEWED {
            background: #ccc;
        }

        .status-dot.OK {
            background: #28a745;
        }

        .status-dot.FLAGGED {
            background: #dc3545;
        }

        .content-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        h2 {
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .file-block {
            margin-top: 15px;
            border: 1px solid #eee;
            border-radius: 4px;
        }

        .file-header {
            background: #f8f9fa;
            padding: 8px 12px;
            font-weight: bold;
            font-family: monospace;
            border-bottom: 1px solid #eee;
        }

        .file-content {
            padding: 12px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 0.9em;
            overflow-x: auto;
            background: #fafafa;
        }

        #controls {
            position: sticky;
            bottom: 0;
            background: white;
            padding: 15px;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 10px;
            align-items: center;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }

        button {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            flex: 1;
        }

        .btn-ok {
            background: #28a745;
            color: white;
        }

        .btn-flag {
            background: #dc3545;
            color: white;
        }

        .btn-dl {
            background: #007bff;
            color: white;
            flex: 0 0 auto;
        }

        input[type="text"] {
            flex: 2;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            #sidebar {
                width: 100%;
                height: 30%;
            }

            #main {
                height: 70%;
            }
        }
    </style>
</head>

<body>
    <div id="sidebar">
        <div class="header">
            <h3>Atoms (<span id="count">0</span>)</h3>
            <button onclick="downloadTSV()" class="btn-dl" style="width:100%; margin-top:10px;">Download TSV</button>
        </div>
        <div id="list"></div>
    </div>
    <div id="main">
        <div id="empty-state" style="text-align: center; margin-top: 50px; color: #888;">Select an atom to view details
        </div>
        <div id="detail-view" style="display:none;">
            <h1 id="atom-title"></h1>
            <div id="atom-buckets"></div>
        </div>
        <div id="controls" style="display:none;">
            <button class="btn-ok" onclick="setFeedback('OK')">MARK OK</button>
            <button class="btn-flag" onclick="setFeedback('FLAGGED')">FLAG</button>
            <input type="text" id="notes" placeholder="Optional notes..." onchange="updateNotes()">
        </div>
    </div>

    <script>
        let currentAtom = null;
        let atomsList = [];

        async function loadAtoms() {
            const res = await fetch('/api/atoms');
            atomsList = await res.json();
            document.getElementById('count').innerText = atomsList.length;
            renderList();
        }

        function renderList() {
            const listEl = document.getElementById('list');
            listEl.innerHTML = '';

            // Sort: PARTIAL first, then by name
            atomsList.sort((a, b) => {
                if (a.class === 'PARTIAL' && b.class !== 'PARTIAL') return -1;
                if (b.class === 'PARTIAL' && a.class !== 'PARTIAL') return 1;
                return a.atom_root.localeCompare(b.atom_root);
            });

            atomsList.forEach(atom => {
                const el = document.createElement('div');
                el.className = `atom-item ${currentAtom && currentAtom.atom_root === atom.atom_root ? 'selected' : ''}`;
                el.onclick = () => selectAtom(atom);
                const name = atom.atom_root.split('/').pop();
                el.innerHTML = `
                    <span class="name">
                        <span class="status-dot ${atom.user_status}"></span>
                        ${name}
                    </span>
                    <span class="sub">
                        <span class="badge ${atom.class}">${atom.class}</span>
                        ${atom.created_files ? '<span style="color:orange">Auto-created files</span>' : ''}
                    </span>
                `;
                listEl.appendChild(el);
            });
        }

        async function selectAtom(atom) {
            currentAtom = atom;
            renderList(); // update selection highlight

            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('detail-view').style.display = 'block';
            document.getElementById('controls').style.display = 'flex';

            document.getElementById('atom-title').innerText = atom.atom_root;
            document.getElementById('notes').value = atom.user_notes || '';

            const bucketsEl = document.getElementById('atom-buckets');
            bucketsEl.innerHTML = '<div style="padding:20px;">Loading details...</div>';

            const res = await fetch(`/api/atom?root=${encodeURIComponent(atom.atom_root)}`);
            const details = await res.json();

            bucketsEl.innerHTML = '';

            // --- SMART RENDER PREVIEW ---
            const previewSection = document.createElement('div');
            previewSection.className = 'content-section';
            previewSection.style.background = '#f8f9fa';
            previewSection.style.border = '2px dashed #ddd';
            previewSection.innerHTML = '<h2>Simulation Preview <span style="font-size:0.6em; font-weight:normal; color:#666">(Visual Approximation)</span></h2><div id="smart-render-stage" style="padding:40px; display:flex; justify-content:center; align-items:center; min-height:150px;"></div>';
            bucketsEl.appendChild(previewSection);

            await renderSmartPreview(atom.atom_root, details);
            // -----------------------------

            ['views', 'data_schema', 'exposed_tokens'].forEach(bucket => {
                const section = document.createElement('div');
                section.className = 'content-section';
                section.innerHTML = `<h2>${bucket}</h2>`;

                if (details[bucket] && details[bucket].length > 0) {
                    details[bucket].forEach(file => {
                        section.innerHTML += `
                            <div class="file-block">
                                <div class="file-header">${file.path}</div>
                                <div class="file-content">${escapeHtml(file.content)}</div>
                            </div>
                        `;
                    });
                } else {
                    section.innerHTML += `<p style="color:#aaa">Empty</p>`;
                }
                bucketsEl.appendChild(section);
            });
        }

        async function renderSmartPreview(root, details) {
            const stage = document.getElementById('smart-render-stage');
            const name = root.split('/').pop().toLowerCase();
            let html = '';

            // Check if we have Golden Code (index.tsx)
            let hasGoldenCode = false;
            if (details.views) {
                hasGoldenCode = details.views.some(f => f.name.endsWith('.tsx'));
            }

            if (hasGoldenCode) {
                // --- WORKBENCH vNext ---

                // Aggregate Granular Tokens from all files
                // Structure: { category: [ {name, value, type} ] }
                let deepTokens = {};

                if (details.exposed_tokens) {
                    details.exposed_tokens.forEach(f => {
                        if (f.tokens && f.tokens.granular_tokens) {
                            Object.keys(f.tokens.granular_tokens).forEach(cat => {
                                if (!deepTokens[cat]) deepTokens[cat] = [];
                                deepTokens[cat].push(...f.tokens.granular_tokens[cat]);
                            });
                        }
                    });
                }

                // Load Font Presets
                let fontPresets = [];
                try {
                    const presetRes = await fetch('/api/fonts/presets');
                    fontPresets = await presetRes.json();
                } catch (e) { console.warn("No presets"); }

                // Generate UI
                html = `
                    <style>
                        @font-face {
                            font-family: 'Roboto Flex';
                            src: url('/fonts/RobotoFlex-VariableFont_GRAD,XOPQ,XTRA,YOPQ,YTAS,YTDE,YTFI,YTLC,YTUC,opsz,slnt,wdth,wght.ttf') format('truetype');
                        }
                        .wb-container { display: flex; height: 100%; overflow: hidden; }
                        .wb-preview { flex: 1; background: #eee; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; position: relative; }
                        .wb-inspector { width: 320px; background: white; border-left: 1px solid #ddd; overflow-y: auto; display: flex; flex-direction: column; }
                        .wb-group { border-bottom: 1px solid #f0f0f0; padding: 15px; }
                        .wb-group h4 { margin: 0 0 10px 0; font-size: 0.8em; text-transform: uppercase; color: #888; letter-spacing: 1px; }
                        .wb-field { margin-bottom: 12px; }
                        .wb-field label { display: block; font-size: 0.75em; font-weight: 500; margin-bottom: 4px; color: #444; }
                        .wb-input { width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em; box-sizing: border-box; }
                        .wb-slider { width: 100%; }
                        .wb-actions { padding: 15px; border-top: 1px solid #ddd; background: #fafafa; }
                        .wb-btn-approve { background: #28a745; color: white; width: 100%; padding: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
                        .wb-btn-approve:hover { background: #218838; }
                        
                        /* Simulation */
                        #live-preview { transition: all 0.1s; } 
                    </style>

                    <div class="wb-container">
                        <div class="wb-preview">
                             <div style="background:gold; color:black; padding:4px 8px; border-radius:4px; font-weight:bold; font-size:0.7em; position:absolute; top:20px; left:20px;">WORKBENCH vNext</div>
                             
                             <!-- The Atom -->
                             <a id="live-preview" href="#" style="display:inline-flex; text-decoration:none;">Click Me</a>
                             
                             <div id="live-debug" style="position:absolute; bottom:20px; left:20px; font-size:0.7em; color:#888; font-family:monospace;"></div>
                        </div>

                        <div class="wb-inspector">
                            <div class="wb-group" style="background:#f8f9fa;">
                                <h4>Status</h4>
                                <div style="font-weight:bold; color:orange;">RENDERABLE</div>
                            </div>
                            
                            <!-- Font Presets -->
                            <div class="wb-group">
                                <h4>Typography Presets</h4>
                                <select id="font-preset-select" class="wb-input">
                                    <option value="">-- Custom --</option>
                                    ${fontPresets.map(p => `<option value='${JSON.stringify(p)}'>${p.name}</option>`).join('')}
                                </select>
                            </div>

                            <!-- Dynamic Categories -->
                            <div id="inspector-content"></div>

                            <div class="wb-actions">
                                <button class="wb-btn-approve" onclick="approveAtom('${root}')">âœ… Approve -> EXPORT_READY</button>
                            </div>
                        </div>
                    </div>
                 `;

                stage.innerHTML = html;

                // Populate Inspector
                const inspector = document.getElementById('inspector-content');

                // Ordering: Copy -> Typography -> Colors -> Layout -> Links
                const order = ['copy', 'typography', 'colors', 'layout', 'links'];
                const cats = Object.keys(deepTokens).sort((a, b) => {
                    const idxA = order.indexOf(a) > -1 ? order.indexOf(a) : 99;
                    const idxB = order.indexOf(b) > -1 ? order.indexOf(b) : 99;
                    return idxA - idxB;
                });

                cats.forEach(cat => {
                    const group = document.createElement('div');
                    group.className = 'wb-group';
                    group.innerHTML = `<h4>${cat}</h4>`;

                    deepTokens[cat].forEach(t => {
                        const div = document.createElement('div');
                        div.className = 'wb-field';

                        let inputHtml = '';
                        if (t.type === 'color' || t.name.toLowerCase().includes('color')) {
                            inputHtml = `
                                <div style="display:flex; gap:5px;">
                                    <input type="text" class="wb-input live-token" data-cat="${cat}" data-name="${t.name}" value="${t.value}">
                                    <input type="color" value="${t.value.startsWith('#') ? t.value : '#000000'}" onchange="this.previousElementSibling.value=this.value; this.previousElementSibling.dispatchEvent(new Event('input'))" style="height:30px;">
                                </div>`;
                        } else if (t.type === 'number' || (!isNaN(t.value) && t.value !== '')) {
                            inputHtml = `<input type="range" class="wb-slider live-token" data-cat="${cat}" data-name="${t.name}" min="0" max="1000" value="${t.value}" oninput="this.nextElementSibling.value=this.value">
                                          <input type="number" class="wb-input" value="${t.value}" onchange="this.previousElementSibling.value=this.value; this.previousElementSibling.dispatchEvent(new Event('input'))">`;
                        } else {
                            inputHtml = `<input type="text" class="wb-input live-token" data-cat="${cat}" data-name="${t.name}" value="${t.value}">`;
                        }

                        div.innerHTML = `<label>${t.name}</label>${inputHtml}`;
                        group.appendChild(div);
                    });

                    inspector.appendChild(group);
                });

                // Bind Logic
                const preview = document.getElementById('live-preview');
                const presetSel = document.getElementById('font-preset-select');

                function update() {
                    const tokens = {};
                    stage.querySelectorAll('.live-token').forEach(inp => {
                        if (!tokens[inp.dataset.cat]) tokens[inp.dataset.cat] = {};
                        tokens[inp.dataset.cat][inp.dataset.name] = inp.value;
                    });

                    // 1. Copy
                    if (tokens.copy && tokens.copy.label) preview.innerText = tokens.copy.label;

                    // 2. Links
                    if (tokens.links && tokens.links.href) preview.href = tokens.links.href;
                    else preview.href = '#';

                    // 3. Colors
                    if (tokens.colors) {
                        if (tokens.colors.background) preview.style.backgroundColor = tokens.colors.background;
                        if (tokens.colors.text) preview.style.color = tokens.colors.text;
                        if (tokens.colors.border) preview.style.borderColor = tokens.colors.border;
                    }

                    // 4. Layout
                    if (tokens.layout) {
                        if (tokens.layout.padding) preview.style.padding = tokens.layout.padding;
                        if (tokens.layout.borderRadius) preview.style.borderRadius = tokens.layout.borderRadius;
                        if (tokens.layout.borderWidth) preview.style.borderWidth = tokens.layout.borderWidth;
                    }

                    // 5. Typography (Variable Font Magic)
                    if (tokens.typography) {
                        const t = tokens.typography;
                        preview.style.fontFamily = t.fontFamily || "'Roboto Flex', sans-serif";
                        preview.style.fontSize = t.fontSize || "16px";

                        // Accumulate axes
                        let axes = [];
                        if (t.weight) axes.push(`"wght" ${t.weight}`);
                        if (t.width) axes.push(`"wdth" ${t.width}`);
                        // Add more mapped axes here if specific tokens existed

                        preview.style.fontVariationSettings = axes.join(', ');
                    }
                }

                // Preset Logic
                presetSel.addEventListener('change', (e) => {
                    if (!e.target.value) return;
                    const preset = JSON.parse(e.target.value);

                    // Update associated sliders/inputs if they exist
                    // Map preset key (wght) to token name (weight) - lightweight mapping for demo
                    const map = { 'wght': 'weight', 'wdth': 'width' };

                    Object.keys(preset).forEach(k => {
                        const tokenName = map[k] || k;
                        const inputs = stage.querySelectorAll(`.live-token[data-name="${tokenName}"]`);
                        inputs.forEach(inp => {
                            inp.value = preset[k];
                            // Update number sibling if exists
                            if (inp.nextElementSibling && inp.nextElementSibling.type === 'number') {
                                inp.nextElementSibling.value = preset[k];
                            }
                            inp.dispatchEvent(new Event('input')); // trigger update
                        });
                    });
                });

                stage.addEventListener('input', update);
                update(); // Init
                return;
            }

            // Extract potential colors from exposed_tokens
            let colors = [];
            if (details.exposed_tokens) {
                details.exposed_tokens.forEach(f => {
                    if (f.tokens && f.tokens.extracted_colors) {
                        colors.push(...f.tokens.extracted_colors);
                    }
                });
            }
            const primaryColor = colors[0] || '#007bff';
            const secondaryColor = colors[1] || '#f8f9fa';

            // Heuristics
            if (name.includes('button')) {
                html = `<button style="padding:10px 20px; border:none; border-radius:6px; background:${primaryColor}; color:white; font-size:16px; font-weight:bold; cursor:pointer;">${name}</button>`;
            } else if (name.includes('input') || name.includes('field')) {
                html = `<input type="text" placeholder="${name}..." style="padding:10px; border:1px solid #ccc; border-radius:6px; width:100%; max-width:300px;">`;
            } else if (name.includes('card') || name.includes('note') || name.includes('tile') || name.includes('block')) {
                html = `
                    <div style="background:white; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.1); width:300px; overflow:hidden;">
                        <div style="height:120px; background:${secondaryColor}; display:flex; align-items:center; justify-content:center; color:#aaa;">Image / Media</div>
                        <div style="padding:20px;">
                            <h3 style="margin:0 0 10px 0; color:#333;">${name} Title</h3>
                            <p style="margin:0; color:#666; font-size:0.9em;">This is a simulated preview of the ${name} atom content.</p>
                            <div style="margin-top:15px; display:flex; gap:10px;">
                                <div style="height:10px; width:60%; background:${primaryColor}; opacity:0.2; border-radius:5px;"></div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (name.includes('header') || name.includes('bar') || name.includes('nav')) {
                html = `
                    <div style="width:100%; background:white; border-bottom:1px solid #ddd; padding:15px 20px; display:flex; align-items:center; justify-content:space-between;">
                        <div style="font-weight:bold; color:${primaryColor};">${name}</div>
                        <div style="display:flex; gap:15px;">
                            <div style="width:20px; height:20px; background:#ddd; border-radius:50%;"></div>
                            <div style="width:20px; height:20px; background:#ddd; border-radius:50%;"></div>
                        </div>
                    </div>
                `;
            } else if (name.includes('switch') || name.includes('toggle')) {
                html = `
                    <div style="width:50px; height:30px; background:${primaryColor}; border-radius:15px; position:relative;">
                        <div style="width:26px; height:26px; background:white; border-radius:50%; position:absolute; top:2px; right:2px; box-shadow:0 2px 4px rgba(0,0,0,0.2);"></div>
                    </div>
                `;
            } else {
                html = `
                    <div style="border:2px dashed #ccc; padding:30px; border-radius:8px; color:#888; text-align:center;">
                        <strong>${name}</strong><br>
                        <span style="font-size:0.8em">Generic Container</span>
                    </div>
                `;
            }

            stage.innerHTML = html;
        }

        async function setFeedback(status) {
            if (!currentAtom) return;
            const notes = document.getElementById('notes').value;

            await fetch('/api/feedback', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    atom_root: currentAtom.atom_root,
                    status: status,
                    notes: notes
                })
            });

            // Local update
            currentAtom.user_status = status;
            currentAtom.user_notes = notes;
            renderList();
        }

        async function updateNotes() {
            if (currentAtom) setFeedback(currentAtom.user_status); // save notes with current status
        }

        function downloadTSV() {
            window.location.href = '/api/export';
        }

        function escapeHtml(text) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        async function approveAtom(root) {
            const res = await fetch('/api/atom/approve', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ atom_root: root })
            });
            const data = await res.json();
            if (data.success) {
                alert('Atom marked as EXPORT_READY!');
                loadAtoms(); // refresh list
            }
        }

        loadAtoms();
    </script>
</body>

</html>