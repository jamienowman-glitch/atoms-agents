# The Law of Agents: Atoms-UI Architecture

> **The Northstar**: "We are creating Shopify, Klaviyo, Photoshop, CapCut... all run by Agents and Humans on collaborative Canvases."

## ğŸ›‘ THE ATOMIC MANDATE
1.  **Never Monolith**: Every concern must be its own "Atom" (Table, Component, Service, Site).
2.  **Collaborative Core**: The "Canvas" is the shared workspace for Humans and Agents.
3.  **Atomic Expansion**: We will not have one central site. We will have many microsites targeting individual markets.
4.  **Registry First**: "If we hit something new, we add it to the Registry."

## ğŸ—ºï¸ Strategic Infrastructure & Auth
> **CRITICAL**: These documents define The Law for Auth, Infrastructure, and Nexus Architecture. Read them before planning any changes.

*   [Auth & Key Playbook (GCP/AWS)](docs/infra/NORTHSTAR_AUTH_SETUP.md)
*   [Nexus Architecture (Domains & Isolation)](docs/infra/NEXUS_ARCHITECTURE.md)

> **Context**: This repository (`atoms-ui`) defines the standard for "Agentic Canvases". All code generated by Agents MUST adhere to this constitution.

## 1. The Skills (Agent Capabilities)
Agents must check `.agent/skills/` for specialized instruction sets.
-   **Canvas Forge** (`.agent/skills/canvas-forge`): How to build new Canvases.
-   **Console Extend** (`.agent/skills/console-extend`): How to add tools to the Dashboard.

## 2. The Hierarchy
We follow a strict separation of concerns, inspired by Atomic Design but tailored for AI-Driven Tooling.

### Level 1: The Harness (Global)
-   **Role**: The "Shell" that holds the tools. It is **Canvas Agnostic**.
-   **Components**: `ToolHarness`, `ToolPill` (Top/Right), `ToolPop` (Bottom), `ChatRail` (Left).
-   **Transport**: MUST use `lib/gate3/transport`. The Harness instances `CanvasTransport` and shares it via Context.
-   **State**: Manages `ToolControlContext`. All "Tools" (sliders, toggles) live here and sync via `transport.sendCommand`.
-   **Rule**: The Harness NEVER knows about the specific canvas content. It only broadcasts signals (tool IDs).

### Level 2: The Controller (`Connected{Block}.tsx`)
-   **Role**: The "Traffic Controller". The specific implementation of a Block type.
-   **Responsibility**:
    1.  **Hydration**: Calls `useToolState` to read Harness signals.
    2.  **Logic**: Calls `useVarioEngine`, `useFeedMapper`, etc.
    3.  **Composition**: Passes final, calculated props down to the Molecules/Atoms.
-   **Rule**: This is the ONLY place where `useToolControl` or `useToolState` is allowed. Lower levels must be "dumb".
-   **Rule**: ALL Mutations must go through `transport.sendCommand`. DO NOT use `fetch` directly.

### Level 3: The Molecule (`{Name}Grid.tsx`)
-   **Role**: The "Container". Defines the layout and structure.
-   **Responsibility**:
    1.  **Layout**: Handles CSS Grid, Flexbox, Spacing variables.
    2.  **Mapping**: Loops over data arrays and renders Atoms.
    3.  **Styles**: Receives global style tokens (bg, color) and applies them to container CSS vars.
-   **Rule**: Never fetch data here. Never call hooks. Receive strictly typed props.

### Level 4: The Atom (`{Name}Tile.tsx`)
-   **Role**: The "Pixel". Pure presentation.
-   **Responsibility**:
    1.  **Render**: Displays the image, text, button.
    2.  **Interaction**: Minimal local interaction (hover state, simple click).
-   **Rule**: 100% Pure Component. No side effects.

## 2. The Standards

### Typography (Vario Engine)
All typography MUST use the global `useVarioEngine` hook.
-   **Do Not**: Hardcode `font-family: Roboto`.
-   **Do**: Pass `fontFamily` index and axes to `useVarioEngine` and apply the returned style.

### CSS Variables
We favor injection of CSS Variables at the *Molecule* level.
-   The Molecule receives `styleBgColor` prop.
-   The Molecule sets `style={{ '--bg': styleBgColor }}`.
-   The Atom uses `background: var(--bg)`.
*Reason*: Performance and cleaner DOM during rapid AI updates.

### File Structure (Standardized)
```text
canvases/{name}/
â”œâ”€â”€ index.ts                # Exports Canvas
â”œâ”€â”€ {Name}Canvas.tsx        # The Main Entry
â”œâ”€â”€ blocks/
â”‚   â”œâ”€â”€ Connected{Name}.tsx # The Controller
â”‚   â”œâ”€â”€ molecules/
â”‚   â”‚   â””â”€â”€ {Name}Grid.tsx  # The Molecule
â”‚   â”œâ”€â”€ atoms/
â”‚   â”‚   â””â”€â”€ {Name}Tile.tsx  # The Atom
â”‚   â””â”€â”€ modifiers/          # Optional (Rows, dividers)
â””â”€â”€ logic/                  # Optional (Mappers)

# 3. The Registry (The Source of Truth)

> **Context**: We are migrating from legacy internal JSONs to a distributed `atoms-registry` repo.

## Multi-Registry Architecture
The Registry is not a single list. It is a Federation of verified assets:
1.  **Muscles** (`atoms-registry/muscle/*.yaml`): Backend Capabilities (Video, Audio, CAD).
2.  **Canvases** (`atoms-registry/canvases/*.yaml`): UI Templates (VideoEditor, GanttChart).
3.  **Atoms** (`atoms-registry/atoms/*.yaml`): Reusable UI Components (ClipTile, ScrubBar).
4.  **Connectors** (`atoms-registry/connectors/*.yaml`): External APIs (Shopify, YouTube).

## The Hybrid Bridge (Migration Strategy)
To bridge the gap between `northstar-engines` (Legacy) and `atoms-ui` (New World):
1.  **Harvest**: A script (`harvest_registry.py`) scans code Repos (`atoms-muscle`, `atoms-ui`) and generates YAML metadata in `atoms-registry`.
2.  **Mount**: `northstar-engines` mounts the `atoms-registry` directory and serves it via `GET /registries/entries`.
3.  **Consume**: `atoms-ui` consumes the registry via the Engine API, ensuring production-grade access control and billing.

## Law of the Forge (Persistence)
-   The **Visual Contract Editor** IS the authoring tool.
-   **Save Path**: Contracts are saved as YAML/JSON to `atoms-registry/canvases/`.
-   **Generation**: The Agent reads the saved `atoms-registry` file to generate the React Code.
-   **Loop**:
    1.  User edits Form in Forge -> Saves to Registry.
    2.  User asks Agent "Update Code" -> Agent reads Registry -> Updates `atoms-ui/canvases`.


```
