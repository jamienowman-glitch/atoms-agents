{% comment %}
Red Pen — Events Feed (Hero + Grid)
- Minimal change to your original: adds one big hero card above the grid.
- New settings:
  • feed_url (paste your Web App JSON URL)
  • show_hero (toggle)
  • hero_mode ("newest" or "next_upcoming")
  • hero_heading (e.g. "Up next")
- All existing display + colour + layout options preserved and reused.
{% endcomment %}

<section id="rp-efeed-{{ section.id }}" class="rp-efeed"
  style="
    --ef-bg: {{ section.settings.bg }};
    --ef-text: {{ section.settings.text }};
    --ef-accent: {{ section.settings.accent }};
    --ef-gap: {{ section.settings.gap }}px;
    --ef-cols-m: {{ section.settings.cols_mobile }};
    --ef-cols-d: {{ section.settings.cols_desktop }};
    --ef-pad-d: {{ section.settings.pad_desktop }}px;
    --ef-pad-m: {{ section.settings.pad_mobile }}px;
    --ef-title: {{ section.settings.title_size }}px;
    --ef-meta: {{ section.settings.meta_size }}px;
  ">
  <div class="rp-efeed__inner">
    {% if section.settings.heading != blank %}
      <h2 class="rp-efeed__heading{% if section.settings.heading_bold %} is-bold{% endif %}">{{ section.settings.heading }}</h2>
    {% endif %}

    {% if section.settings.show_hero %}
      <div class="rp-efeed__hero-wrap" aria-live="polite">
        {% if section.settings.hero_heading != blank %}
          <div class="rp-efeed__hero-label">{{ section.settings.hero_heading }}</div>
        {% endif %}
        <div class="rp-efeed__hero" role="region" aria-label="Featured event"></div>
      </div>
    {% endif %}

    <div class="rp-efeed__grid" role="list" aria-live="polite"></div>
  </div>

  <style>
    #rp-efeed-{{ section.id }}{background:var(--ef-bg);color:var(--ef-text);padding:var(--ef-pad-d) 0;}
    @media(max-width:749px){#rp-efeed-{{ section.id }}{padding:var(--ef-pad-m) 0;}}
    #rp-efeed-{{ section.id }} .rp-efeed__inner{width:min(1200px,94vw);margin:0 auto;}
    #rp-efeed-{{ section.id }} .rp-efeed__heading{margin:0 0 12px;letter-spacing:.06em;text-transform:uppercase;font-size:14px;opacity:.9}
    #rp-efeed-{{ section.id }} .rp-efeed__heading.is-bold{font-weight:700}

    /* HERO */
    #rp-efeed-{{ section.id }} .rp-efeed__hero-wrap{margin:0 0 calc(var(--ef-gap) * 1.25);}
    #rp-efeed-{{ section.id }} .rp-efeed__hero-label{
      font-size:12px;letter-spacing:.08em;text-transform:uppercase;opacity:.85;margin:0 0 8px
    }
    #rp-efeed-{{ section.id }} .rp-efeed__hero .card{
      display:flex;flex-direction:column;background:#fff;color:#111;border:1px solid rgba(0,0,0,.08)
    }
    #rp-efeed-{{ section.id }} .rp-efeed__hero .thumb{
      position:relative;background:#f2f2f2;overflow:hidden
    }
    #rp-efeed-{{ section.id }} .rp-efeed__hero .thumb img{
      width:100%;height:auto;display:block;object-fit:contain
    }
    #rp-efeed-{{ section.id }} .rp-efeed__hero .body{padding:12px 14px 14px}
    #rp-efeed-{{ section.id }} .rp-efeed__hero .t{font-size:calc(var(--ef-title) * 1.15);line-height:1.2}
    #rp-efeed-{{ section.id }} .rp-efeed__hero .m{font-size:calc(var(--ef-meta) * 1.05)}

    /* GRID */
    #rp-efeed-{{ section.id }} .rp-efeed__grid{
      display:grid; gap:var(--ef-gap);
      grid-template-columns:repeat(var(--ef-cols-d),minmax(0,1fr));
    }
    @media(max-width:749px){
      #rp-efeed-{{ section.id }} .rp-efeed__grid{grid-template-columns:repeat(var(--ef-cols-m),minmax(0,1fr));}
    }

    /* Card base (shared) */
    #rp-efeed-{{ section.id }} .card{display:flex;flex-direction:column;background:#fff;color:#111;border:1px solid rgba(0,0,0,.08)}
    #rp-efeed-{{ section.id }} .thumb{position:relative;background:#f2f2f2;overflow:hidden}
    #rp-efeed-{{ section.id }} .thumb img{width:100%;height:auto;display:block;object-fit:contain}

    /* Modes (grid only) */
    #rp-efeed-{{ section.id }} .mode-image .card{border:none;background:transparent}
    #rp-efeed-{{ section.id }} .mode-image .body{display:none}
    #rp-efeed-{{ section.id }} .mode-compact .body{padding:6px 6px 4px}
    #rp-efeed-{{ section.id }} .mode-compact .t{font-weight:700;margin:0 0 2px}
    #rp-efeed-{{ section.id }} .mode-compact .m{opacity:.8;margin:0}
    #rp-efeed-{{ section.id }} .mode-full .body{padding:10px 12px 12px}

    /* Text sizes */
    #rp-efeed-{{ section.id }} .t{font-size:var(--ef-title);line-height:1.25}
    #rp-efeed-{{ section.id }} .m{font-size:var(--ef-meta)}

    /* CTAs + tiny arrow */
    #rp-efeed-{{ section.id }} .cta{display:flex;gap:10px;align-items:center;margin-top:6px}
    #rp-efeed-{{ section.id }} .cta a{font-size:14px;text-decoration:none;color:var(--ef-accent)}
    #rp-efeed-{{ section.id }} .cta a:hover{transform:translateX(2px)}
    #rp-efeed-{{ section.id }} .tiny{margin-top:4px;text-align:center}
    #rp-efeed-{{ section.id }} .tiny a{font-size:14px;text-decoration:none;color:var(--ef-accent)}
  </style>

  <script>
  (function(){
    var root = document.getElementById('rp-efeed-{{ section.id }}');
    var heroWrap = root.querySelector('.rp-efeed__hero');
    var grid = root.querySelector('.rp-efeed__grid');

    // Settings (now with feed_url + hero controls)
    var feedUrl = {{ section.settings.feed_url | json }}; // e.g. https://script.google.com/.../exec?action=list&limit=...
    var mode = {{ section.settings.display_mode | json }}; // image|compact|full
    var showHero = {{ section.settings.show_hero | json }};
    var heroMode = {{ section.settings.hero_mode | json }}; // newest | next_upcoming

    var showTitle = {{ section.settings.show_title | json }};
    var showDate  = {{ section.settings.show_date  | json }};
    var showPlace = {{ section.settings.show_place | json }};
    var placeCityOnly = {{ section.settings.city_only | json }};
    var showCTAs  = {{ section.settings.show_ctas  | json }};
    var showTiny  = {{ section.settings.show_tiny  | json }};
    var dateFmt   = {{ section.settings.date_format | json }};
    var fixedUrl  = {{ section.settings.fixed_url | json }};

    // Fallback: build URL from legacy params if feed_url not provided
    if(!feedUrl || !String(feedUrl).trim()){
      var base = "https://script.google.com/macros/s/AKfycbwsBvDVHattnOp7JbJjRkFoLAkrVmrSx1ESRQ3LJSCRUXvmiaOdd9dR44BGZqSTkLeg/exec";
      var p = [];
      p.push('action=list');
      p.push('limit=' + encodeURIComponent({{ section.settings.limit | json }}));
      {% if section.settings.window_days > 0 %}p.push('window={{ section.settings.window_days }}');{% endif %}
      {% if section.settings.include_past %}p.push('include_past=1');{% endif %}
      {% if section.settings.only_type != blank %}p.push('type={{ section.settings.only_type }}');{% endif %}
      {% if section.settings.random_on_load %}p.push('random=1');{% endif %}
      var url = base + '?' + p.join('&');
    }else{
      var url = feedUrl;
    }

    function fmtDate(iso){
      if(!iso || !showDate) return '';
      try{
        var d = new Date(String(iso).replace(' ','T'));
        if(isNaN(d)) return String(iso);
        if(dateFmt==='dd/mm/yy'){
          var dd=String(d.getDate()).padStart(2,'0');
          var mm=String(d.getMonth()+1).padStart(2,'0');
          var yy=String(d.getFullYear()).slice(-2);
          return dd+'/'+mm+'/'+yy;
        }
        if(dateFmt==='dd MMM yyyy'){
          return d.toLocaleDateString(undefined,{day:'2-digit',month:'short',year:'numeric'});
        }
        return d.toLocaleDateString(undefined,{weekday:'short',day:'2-digit',month:'short',year:'numeric'});
      }catch(e){ return String(iso); }
    }

    // Convert Drive URLs to direct image
    function driveDirect(u){
      if(!u) return u;
      try{
        var m = u.match(/\/d\/([a-zA-Z0-9_-]{10,})/);
        if(m && m[1]) return 'https://lh3.googleusercontent.com/d/'+m[1]+'=w1600';
        var id = (new URL(u)).searchParams.get('id');
        if(id) return 'https://lh3.googleusercontent.com/d/'+id+'=w1600';
      }catch(e){}
      return u;
    }

    function buildCard(ev, isHero){
      var card = document.createElement('article');
      card.className = 'card';
      card.setAttribute('role', isHero ? 'article' : 'listitem');

      var targetHref = fixedUrl || ev.event_url || ev.tickets_url || '#';

      var link = document.createElement('a');
      link.className = 'thumb';
      link.href = targetHref;
      link.target = '_self';
      link.rel = 'noopener';

      var img = document.createElement('img');
      img.loading='lazy'; img.decoding='async'; img.referrerPolicy='no-referrer';
      img.alt = ev.title || 'Event';
      img.src = driveDirect(ev.poster_url || '') || 'https://dummyimage.com/1200x1600/eeeeee/aaaaaa.png&text=Event';
      img.onerror = function(){
        if(this.dataset.fallback==='1'){
          this.src='https://dummyimage.com/1200x1600/eeeeee/aaaaaa.png&text=Event';
          return;
        }
        this.dataset.fallback='1';
        try{
          var id=null,m=(ev.poster_url||'').match(/\/d\/([a-zA-Z0-9_-]{10,})/);
          if(m&&m[1]) id=m[1]; else id=(new URL(ev.poster_url||'')).searchParams.get('id');
          this.src = id ? ('https://drive.google.com/uc?export=view&id='+id) : 'https://dummyimage.com/1200x1600/eeeeee/aaaaaa.png&text=Event';
        }catch(e){ this.src='https://dummyimage.com/1200x1600/eeeeee/aaaaaa.png&text=Event'; }
      };

      link.appendChild(img);
      card.appendChild(link);

      // Body (respect toggles)
      var showBody = (mode !== 'image') || isHero; // hero always shows body
      if(showBody){
        var body = document.createElement('div'); body.className = 'body';

        if(showTitle){
          var t=document.createElement('div'); t.className='t'; t.textContent = ev.title || '';
          body.appendChild(t);
        }

        if(showDate || showPlace){
          var bits=[];
          var d = fmtDate(ev.start_date);
          if(d) bits.push(d);
          if(showPlace){
            var loc='';
            if(placeCityOnly){
              if(ev.city) loc = ev.city;
            }else{
              if(ev.city) loc = ev.city;
              if(ev.country) loc = loc ? (loc+', '+ev.country) : ev.country;
            }
            if(loc) bits.push(loc);
          }
          var m=document.createElement('div'); m.className='m'; m.textContent = bits.filter(Boolean).join(' · ');
          body.appendChild(m);
        }

        if(showCTAs){
          var c=document.createElement('div'); c.className='cta';
          var href1 = fixedUrl || ev.tickets_url || targetHref;
          var href2 = fixedUrl || ev.event_url   || targetHref;
          if(ev.tickets_url || fixedUrl){
            var a1=document.createElement('a'); a1.href=href1; a1.target='_self'; a1.rel='noopener'; a1.textContent='Tickets →'; c.appendChild(a1);
          }
          if(ev.event_url || fixedUrl){
            var a2=document.createElement('a'); a2.href=href2; a2.target='_self'; a2.rel='noopener'; a2.textContent='More info →'; c.appendChild(a2);
          }
          body.appendChild(c);
        }

        if(showTiny && !showCTAs){
          var tiny=document.createElement('div'); tiny.className='tiny';
          var ta=document.createElement('a'); ta.href=targetHref; ta.target='_self'; ta.rel='noopener'; ta.textContent='→';
          tiny.appendChild(ta); body.appendChild(tiny);
        }

        card.appendChild(body);
      }else if(showTiny){
        var tiny=document.createElement('div'); tiny.className='tiny';
        var ta=document.createElement('a'); ta.href=targetHref; ta.target='_self'; ta.rel='noopener'; ta.textContent='→';
        card.appendChild(tiny); tiny.appendChild(ta);
      }

      return card;
    }

    function pickHero(items){
      if(!Array.isArray(items) || !items.length) return { hero:null, rest:[] };
      if(heroMode === 'next_upcoming'){
        var now = new Date();
        var idx = -1, bestTime = Infinity;
        items.forEach(function(ev,i){
          if(!ev.start_date) return;
          var t = new Date(String(ev.start_date).replace(' ','T')).getTime();
          if(!isNaN(t) && t >= now.getTime() && t < bestTime){ bestTime = t; idx = i; }
        });
        if(idx === -1) idx = 0; // fallback to first
        var hero = items[idx];
        var rest = items.slice(0,idx).concat(items.slice(idx+1));
        return { hero:hero, rest:rest };
      }else{
        // newest (first item from feed)
        return { hero: items[0], rest: items.slice(1) };
      }
    }

    fetch(url).then(r=>r.json()).then(function(items){
      if(!Array.isArray(items) || !items.length){
        if(heroWrap) heroWrap.innerHTML = '';
        grid.innerHTML = '<div style="opacity:.7;font-size:14px">No upcoming events.</div>';
        return;
      }

      var heroData = showHero ? pickHero(items) : { hero:null, rest:items };
      var hero = heroData.hero, rest = heroData.rest;

      if(showHero && hero && heroWrap){
        heroWrap.innerHTML = '';
        heroWrap.appendChild(buildCard(hero, true));
      }

      grid.classList.remove('mode-image','mode-compact','mode-full');
      grid.classList.add('mode-'+(mode||'full'));

      var frag = document.createDocumentFragment();
      rest.forEach(function(ev){
        frag.appendChild(buildCard(ev, false));
      });
      grid.innerHTML = '';
      grid.appendChild(frag);
    }).catch(function(){
      if(heroWrap) heroWrap.innerHTML = '';
      grid.innerHTML = '<div style="opacity:.7;font-size:14px">Couldn’t load events.</div>';
    });
  })();
  </script>
</section>

{% schema %}
{
  "name": "Events Feed (Hero + Grid)",
  "settings": [
    { "type": "text", "id": "heading", "label": "Heading", "default": "Upcoming events" },
    { "type": "checkbox", "id": "heading_bold", "label": "Bold heading", "default": false },

    { "type": "url", "id": "feed_url", "label": "Feed URL (paste full Web App / JSON URL)", "default": "/" },
    { "type": "text", "id": "fixed_url", "label": "Fixed click-through URL (override all links)", "default": "https://redpenstreetboard.online/pages/streetboard-events" },

    { "type": "checkbox", "id": "show_hero", "label": "Show hero card", "default": true },
    { "type": "select", "id": "hero_mode", "label": "Hero picks", "default": "next_upcoming", "options": [
      { "value": "next_upcoming", "label": "Next upcoming by date" },
      { "value": "newest", "label": "Newest in feed" }
    ]},
    { "type": "text", "id": "hero_heading", "label": "Hero label (e.g. Up next / Next event)", "default": "Up next" },

    { "type": "range", "id": "limit", "label": "Max events (legacy builder)", "min": 1, "max": 100, "step": 1, "default": 24 },
    { "type": "range", "id": "window_days", "label": "Only next N days (legacy builder, 0 = all)", "min": 0, "max": 365, "step": 5, "default": 0 },
    { "type": "select", "id": "only_type", "label": "Filter type (legacy builder)", "default": "", "options": [
      { "value": "", "label": "All" },
      { "value": "event", "label": "Events only" },
      { "value": "livestream", "label": "Livestreams only" },
      { "value": "promo", "label": "Promos only" }
    ]},
    { "type": "checkbox", "id": "include_past", "label": "Include past events (legacy builder)", "default": false },
    { "type": "checkbox", "id": "random_on_load", "label": "Randomise on load (legacy builder)", "default": false },

    { "type": "select", "id": "display_mode", "label": "Grid display mode", "default": "full", "options": [
      { "value": "image", "label": "Image only" },
      { "value": "compact", "label": "Compact label" },
      { "value": "full", "label": "Full card" }
    ]},

    { "type": "checkbox", "id": "show_title", "label": "Show title", "default": true },
    { "type": "checkbox", "id": "show_date", "label": "Show date", "default": true },
    { "type": "select", "id": "date_format", "label": "Date format", "default": "dd/mm/yy", "options": [
      { "value": "dd/mm/yy", "label": "dd/mm/yy" },
      { "value": "dd MMM yyyy", "label": "dd MMM yyyy" },
      { "value": "EEE, dd MMM yyyy", "label": "EEE, dd MMM yyyy" }
    ]},
    { "type": "checkbox", "id": "show_place", "label": "Show city/country", "default": true },
    { "type": "checkbox", "id": "city_only", "label": "City only (no country)", "default": false },
    { "type": "checkbox", "id": "show_ctas", "label": "Show CTA links", "default": false },
    { "type": "checkbox", "id": "show_tiny", "label": "Show tiny arrow under tile", "default": true },

    { "type": "color", "id": "bg", "label": "Background", "default": "#ffffff" },
    { "type": "color", "id": "text", "label": "Text", "default": "#111111" },
    { "type": "color", "id": "accent", "label": "Link/Accent", "default": "#F50E0E" },

    { "type": "range", "id": "title_size", "label": "Title size", "min": 12, "max": 24, "step": 1, "default": 12 },
    { "type": "range", "id": "meta_size", "label": "Meta size", "min": 10, "max": 18, "step": 1, "default": 10 },

    { "type": "range", "id": "cols_mobile", "label": "Columns (mobile)", "min": 1, "max": 6, "step": 1, "default": 2 },
    { "type": "range", "id": "cols_desktop", "label": "Columns (desktop)", "min": 1, "max": 20, "step": 1, "default": 6 },
    { "type": "range", "id": "gap", "label": "Gap", "min": 0, "max": 24, "step": 2, "default": 12 },

    { "type": "range", "id": "pad_desktop", "label": "Padding (desktop)", "min": 0, "max": 120, "step": 8, "default": 40 },
    { "type": "range", "id": "pad_mobile", "label": "Padding (mobile)", "min": 0, "max": 80, "step": 4, "default": 20 }
  ],
  "presets": [{ "name": "Events Feed (Hero + Grid)", "category": "Red Pen" }]
}
{% endschema %}