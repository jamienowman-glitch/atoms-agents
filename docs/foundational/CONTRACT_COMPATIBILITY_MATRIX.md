# Phase 2 — Contract Compatibility Check

| Contract Requirement | Exists? (yes / partial / no) | Evidence | Must Live In (repo) | Why |
| --- | --- | --- | --- | --- |
| Tool invocation choke point | partial | GateChain enforces kill-switch/firearms/strategy lock/budget on `/actions/execute`. Agent tool calls do not route through it today. | Engines for enforcement, Agents for mandatory routing | Need single entrypoint so all tool/muscle calls traverse GateChain with request context applied. |
| Firearms licensing enforcement | partial | Dangerous actions map + require_licence_or_raise in GateChain. | Engines | Enforcement only fires when GateChain is invoked; agents/tools/canvas commands not universally bound to it. |
| Strategy lock enforcement | partial | StrategyLockService require_strategy_lock_or_raise; GateChain calls it. | Engines | Locks exist but caller-provided contexts (run/step/surface) not enforced from agents/UI, and some surfaces (canvas, tool) bypass GateChain. |
| Canvas commit + snapshot + replay | partial | Canvas command API exists with base_rev/idempotency checks but uses in-memory repo; timeline append/list exists; UI kernel/transport manage optimistic state and local replay cursor. | Engines (durable commands/timeline), UI (client replay) | Durable commit log and server-side snapshot/replay are not wired; localStorage cursors are client-only and non-authoritative. |
| Tool → canvas mutation rule | no | No contract binding tool results to canvas operations; apply_command accepts any command args without source validation. | Engines (gate + validator), Agents (tool-to-canvas adapter) | Need deterministic rule so tool outputs mutate canvas only via validated commands with provenance. |
| Idempotency | partial | Canvas commands track idempotency_key in memory; event_spine append-only; other writes (blackboard, budget, analytics) lack idempotent tokens in APIs. | Engines | Idempotency must survive restarts and multi-node; current in-memory tracking is non-durable and not uniformly exposed. |
| Error envelope standardization | no | Routes return heterogeneous errors (strings, dicts) across event_spine, budget, strategy_lock, actions. | Engines (common error schema) | Clients cannot rely on uniform error codes/fields for retries and UI surfacing. |
| Discovery surfaces | partial | Agents server exposes nodes/flows/personas/tasks/providers/models; no unified tool/atom/canvas exposure discovery; registry is filesystem-only. | Agents (registry API), UI (consumer), Engines (authoritative if needed) | Contract requires discoverable tools/atoms/exposures; current discovery is limited to registry cards and lacks runtime surfaces. |
