# PHASE 0.5 Multi-Cloud Routing Wiring

## 1) Routing Wiring Plan

### GCP (Firestore + GCS)
| resource_kind | backend_type | service | required config fields | routing registry payload example |
| --- | --- | --- | --- | --- |
| event_spine | document | Firestore | project_id=northstar-routing-prod; collection=event_spine; location=us-central1; credentials_secret=gcp/northstar-routing-prod-sa | ```json {"route_name":"gcp-event-spine","resource_kind":"event_spine","provider":"gcp","backend":"firestore","config":{"project_id":"northstar-routing-prod","collection":"event_spine","location":"us-central1","credentials_secret":"gcp/northstar-routing-prod-sa"}}``` |
| memory_store | document | Firestore | project_id=northstar-routing-prod; collection=memory_store; location=us-central1; credentials_secret=gcp/northstar-routing-prod-sa | ```json {"route_name":"gcp-memory-store","resource_kind":"memory_store","provider":"gcp","backend":"firestore","config":{"project_id":"northstar-routing-prod","collection":"memory_store","location":"us-central1","credentials_secret":"gcp/northstar-routing-prod-sa"}}``` |
| blackboard_store | document | Firestore | project_id=northstar-routing-prod; collection=blackboard_store; location=us-central1; credentials_secret=gcp/northstar-routing-prod-sa | ```json {"route_name":"gcp-blackboard-store","resource_kind":"blackboard_store","provider":"gcp","backend":"firestore","config":{"project_id":"northstar-routing-prod","collection":"blackboard_store","location":"us-central1","credentials_secret":"gcp/northstar-routing-prod-sa"}}``` |
| tabular_store | document | Firestore | project_id=northstar-routing-prod; collection=tabular_store; location=us-central1; credentials_secret=gcp/northstar-routing-prod-sa | ```json {"route_name":"gcp-tabular-store","resource_kind":"tabular_store","provider":"gcp","backend":"firestore","config":{"project_id":"northstar-routing-prod","collection":"tabular_store","location":"us-central1","credentials_secret":"gcp/northstar-routing-prod-sa"}}``` |
| analytics_store | document | Firestore | project_id=northstar-routing-prod; collection=analytics_store; location=us-central1; credentials_secret=gcp/northstar-routing-prod-sa | ```json {"route_name":"gcp-analytics-store","resource_kind":"analytics_store","provider":"gcp","backend":"firestore","config":{"project_id":"northstar-routing-prod","collection":"analytics_store","location":"us-central1","credentials_secret":"gcp/northstar-routing-prod-sa"}}``` |
| budget_store | document | Firestore | project_id=northstar-routing-prod; collection=budget_store; location=us-central1; credentials_secret=gcp/northstar-routing-prod-sa | ```json {"route_name":"gcp-budget-store","resource_kind":"budget_store","provider":"gcp","backend":"firestore","config":{"project_id":"northstar-routing-prod","collection":"budget_store","location":"us-central1","credentials_secret":"gcp/northstar-routing-prod-sa"}}``` |
| notes_store | document | Firestore | project_id=northstar-routing-prod; collection=notes_store; location=us-central1; credentials_secret=gcp/northstar-routing-prod-sa | ```json {"route_name":"gcp-notes-store","resource_kind":"notes_store","provider":"gcp","backend":"firestore","config":{"project_id":"northstar-routing-prod","collection":"notes_store","location":"us-central1","credentials_secret":"gcp/northstar-routing-prod-sa"}}``` |
| seo_config_store | document | Firestore | project_id=northstar-routing-prod; collection=seo_config_store; location=us-central1; credentials_secret=gcp/northstar-routing-prod-sa | ```json {"route_name":"gcp-seo-config-store","resource_kind":"seo_config_store","provider":"gcp","backend":"firestore","config":{"project_id":"northstar-routing-prod","collection":"seo_config_store","location":"us-central1","credentials_secret":"gcp/northstar-routing-prod-sa"}}``` |
| object_store | object | GCS | bucket=northstar-routing-objects; prefix=objects/; location=us-central1; credentials_secret=gcp/northstar-routing-prod-sa | ```json {"route_name":"gcp-object-store","resource_kind":"object_store","provider":"gcp","backend":"gcs","config":{"bucket":"northstar-routing-objects","prefix":"objects/","location":"us-central1","credentials_secret":"gcp/northstar-routing-prod-sa"}}``` |
| media_output_store | object | GCS | bucket=northstar-routing-media; prefix=media/; location=us-central1; credentials_secret=gcp/northstar-routing-prod-sa | ```json {"route_name":"gcp-media-output-store","resource_kind":"media_output_store","provider":"gcp","backend":"gcs","config":{"bucket":"northstar-routing-media","prefix":"media/","location":"us-central1","credentials_secret":"gcp/northstar-routing-prod-sa"}}``` |

### AWS (DynamoDB + S3)
| resource_kind | backend_type | service | required config fields | routing registry payload example |
| --- | --- | --- | --- | --- |
| event_spine | key-value | DynamoDB | region=us-east-1; table=event_spine; pk=pk; sk=sk; credentials_secret=aws/northstar-routing | ```json {"route_name":"aws-event-spine","resource_kind":"event_spine","provider":"aws","backend":"dynamodb","config":{"region":"us-east-1","table":"event_spine","pk":"pk","sk":"sk","credentials_secret":"aws/northstar-routing"}}``` |
| memory_store | key-value | DynamoDB | region=us-east-1; table=memory_store; pk=pk; sk=sk; credentials_secret=aws/northstar-routing | ```json {"route_name":"aws-memory-store","resource_kind":"memory_store","provider":"aws","backend":"dynamodb","config":{"region":"us-east-1","table":"memory_store","pk":"pk","sk":"sk","credentials_secret":"aws/northstar-routing"}}``` |
| blackboard_store | key-value | DynamoDB | region=us-east-1; table=blackboard_store; pk=pk; sk=sk; credentials_secret=aws/northstar-routing | ```json {"route_name":"aws-blackboard-store","resource_kind":"blackboard_store","provider":"aws","backend":"dynamodb","config":{"region":"us-east-1","table":"blackboard_store","pk":"pk","sk":"sk","credentials_secret":"aws/northstar-routing"}}``` |
| tabular_store | key-value | DynamoDB | region=us-east-1; table=tabular_store; pk=pk; sk=sk; credentials_secret=aws/northstar-routing | ```json {"route_name":"aws-tabular-store","resource_kind":"tabular_store","provider":"aws","backend":"dynamodb","config":{"region":"us-east-1","table":"tabular_store","pk":"pk","sk":"sk","credentials_secret":"aws/northstar-routing"}}``` |
| analytics_store | key-value | DynamoDB | region=us-east-1; table=analytics_store; pk=pk; sk=sk; credentials_secret=aws/northstar-routing | ```json {"route_name":"aws-analytics-store","resource_kind":"analytics_store","provider":"aws","backend":"dynamodb","config":{"region":"us-east-1","table":"analytics_store","pk":"pk","sk":"sk","credentials_secret":"aws/northstar-routing"}}``` |
| budget_store | key-value | DynamoDB | region=us-east-1; table=budget_store; pk=pk; sk=sk; credentials_secret=aws/northstar-routing | ```json {"route_name":"aws-budget-store","resource_kind":"budget_store","provider":"aws","backend":"dynamodb","config":{"region":"us-east-1","table":"budget_store","pk":"pk","sk":"sk","credentials_secret":"aws/northstar-routing"}}``` |
| notes_store | key-value | DynamoDB | region=us-east-1; table=notes_store; pk=pk; sk=sk; credentials_secret=aws/northstar-routing | ```json {"route_name":"aws-notes-store","resource_kind":"notes_store","provider":"aws","backend":"dynamodb","config":{"region":"us-east-1","table":"notes_store","pk":"pk","sk":"sk","credentials_secret":"aws/northstar-routing"}}``` |
| seo_config_store | key-value | DynamoDB | region=us-east-1; table=seo_config_store; pk=pk; sk=sk; credentials_secret=aws/northstar-routing | ```json {"route_name":"aws-seo-config-store","resource_kind":"seo_config_store","provider":"aws","backend":"dynamodb","config":{"region":"us-east-1","table":"seo_config_store","pk":"pk","sk":"sk","credentials_secret":"aws/northstar-routing"}}``` |
| object_store | object | S3 | bucket=northstar-routing-objects-us-east-1; prefix=objects/; region=us-east-1; credentials_secret=aws/northstar-routing | ```json {"route_name":"aws-object-store","resource_kind":"object_store","provider":"aws","backend":"s3","config":{"bucket":"northstar-routing-objects-us-east-1","prefix":"objects/","region":"us-east-1","credentials_secret":"aws/northstar-routing"}}``` |
| media_output_store | object | S3 | bucket=northstar-routing-media-us-east-1; prefix=media/; region=us-east-1; credentials_secret=aws/northstar-routing | ```json {"route_name":"aws-media-output-store","resource_kind":"media_output_store","provider":"aws","backend":"s3","config":{"bucket":"northstar-routing-media-us-east-1","prefix":"media/","region":"us-east-1","credentials_secret":"aws/northstar-routing"}}``` |

### Azure (Cosmos DB SQL API + Blob Storage)
| resource_kind | backend_type | service | required config fields | routing registry payload example |
| --- | --- | --- | --- | --- |
| event_spine | document | Cosmos DB (SQL) | account=northstar-cosmos-prod; database=northstar-routing; container=event_spine; partition_key=/pk; credentials_secret=azure/northstar-routing-primary-key | ```json {"route_name":"azure-event-spine","resource_kind":"event_spine","provider":"azure","backend":"cosmos_sql","config":{"account":"northstar-cosmos-prod","database":"northstar-routing","container":"event_spine","partition_key":"/pk","credentials_secret":"azure/northstar-routing-primary-key"}}``` |
| memory_store | document | Cosmos DB (SQL) | account=northstar-cosmos-prod; database=northstar-routing; container=memory_store; partition_key=/pk; credentials_secret=azure/northstar-routing-primary-key | ```json {"route_name":"azure-memory-store","resource_kind":"memory_store","provider":"azure","backend":"cosmos_sql","config":{"account":"northstar-cosmos-prod","database":"northstar-routing","container":"memory_store","partition_key":"/pk","credentials_secret":"azure/northstar-routing-primary-key"}}``` |
| blackboard_store | document | Cosmos DB (SQL) | account=northstar-cosmos-prod; database=northstar-routing; container=blackboard_store; partition_key=/pk; credentials_secret=azure/northstar-routing-primary-key | ```json {"route_name":"azure-blackboard-store","resource_kind":"blackboard_store","provider":"azure","backend":"cosmos_sql","config":{"account":"northstar-cosmos-prod","database":"northstar-routing","container":"blackboard_store","partition_key":"/pk","credentials_secret":"azure/northstar-routing-primary-key"}}``` |
| tabular_store | document | Cosmos DB (SQL) | account=northstar-cosmos-prod; database=northstar-routing; container=tabular_store; partition_key=/pk; credentials_secret=azure/northstar-routing-primary-key | ```json {"route_name":"azure-tabular-store","resource_kind":"tabular_store","provider":"azure","backend":"cosmos_sql","config":{"account":"northstar-cosmos-prod","database":"northstar-routing","container":"tabular_store","partition_key":"/pk","credentials_secret":"azure/northstar-routing-primary-key"}}``` |
| analytics_store | document | Cosmos DB (SQL) | account=northstar-cosmos-prod; database=northstar-routing; container=analytics_store; partition_key=/pk; credentials_secret=azure/northstar-routing-primary-key | ```json {"route_name":"azure-analytics-store","resource_kind":"analytics_store","provider":"azure","backend":"cosmos_sql","config":{"account":"northstar-cosmos-prod","database":"northstar-routing","container":"analytics_store","partition_key":"/pk","credentials_secret":"azure/northstar-routing-primary-key"}}``` |
| budget_store | document | Cosmos DB (SQL) | account=northstar-cosmos-prod; database=northstar-routing; container=budget_store; partition_key=/pk; credentials_secret=azure/northstar-routing-primary-key | ```json {"route_name":"azure-budget-store","resource_kind":"budget_store","provider":"azure","backend":"cosmos_sql","config":{"account":"northstar-cosmos-prod","database":"northstar-routing","container":"budget_store","partition_key":"/pk","credentials_secret":"azure/northstar-routing-primary-key"}}``` |
| notes_store | document | Cosmos DB (SQL) | account=northstar-cosmos-prod; database=northstar-routing; container=notes_store; partition_key=/pk; credentials_secret=azure/northstar-routing-primary-key | ```json {"route_name":"azure-notes-store","resource_kind":"notes_store","provider":"azure","backend":"cosmos_sql","config":{"account":"northstar-cosmos-prod","database":"northstar-routing","container":"notes_store","partition_key":"/pk","credentials_secret":"azure/northstar-routing-primary-key"}}``` |
| seo_config_store | document | Cosmos DB (SQL) | account=northstar-cosmos-prod; database=northstar-routing; container=seo_config_store; partition_key=/pk; credentials_secret=azure/northstar-routing-primary-key | ```json {"route_name":"azure-seo-config-store","resource_kind":"seo_config_store","provider":"azure","backend":"cosmos_sql","config":{"account":"northstar-cosmos-prod","database":"northstar-routing","container":"seo_config_store","partition_key":"/pk","credentials_secret":"azure/northstar-routing-primary-key"}}``` |
| object_store | object | Blob Storage | account=northstarroutingstore; container=objects; prefix=objects/; credentials_secret=azure/northstar-routing-storage-key | ```json {"route_name":"azure-object-store","resource_kind":"object_store","provider":"azure","backend":"blob","config":{"account":"northstarroutingstore","container":"objects","prefix":"objects/","credentials_secret":"azure/northstar-routing-storage-key"}}``` |
| media_output_store | object | Blob Storage | account=northstarroutingstore; container=media; prefix=media/; credentials_secret=azure/northstar-routing-storage-key | ```json {"route_name":"azure-media-output-store","resource_kind":"media_output_store","provider":"azure","backend":"blob","config":{"account":"northstarroutingstore","container":"media","prefix":"media/","credentials_secret":"azure/northstar-routing-storage-key"}}``` |

## 2) Execution Steps
- Create cloud resources if missing:
  - GCP: enable Firestore in project northstar-routing-prod (native mode, us-central1); create GCS buckets northstar-routing-objects and northstar-routing-media; grant service account tied to secret gcp/northstar-routing-prod-sa Storage Object Admin and Firestore access.
  - AWS: create DynamoDB tables named above with partition key pk (string) and sort key sk (string) in us-east-1; enable point-in-time recovery; create S3 buckets northstar-routing-objects-us-east-1 and northstar-routing-media-us-east-1; IAM user/role referenced by aws/northstar-routing with DynamoDB full access on these tables and S3 access on these buckets.
  - Azure: create resource group northstar-routing-rg; create Cosmos DB SQL account northstar-cosmos-prod with database northstar-routing and containers named above (partition key /pk, autoscale); create storage account northstarroutingstore with containers objects and media; store primary keys in secrets azure/northstar-routing-primary-key and azure/northstar-routing-storage-key.
- Configure credentials/identities: ensure routing services can read the secrets referenced in payloads; set roles for read/write as required.
- Insert routing registry entries using the payloads above (one per resource_kind per cloud) through the existing routing registry apply mechanism.
- Restart/reload engines to pick up new routes after entries are applied.

## 3) Proof of Reality
Execute the write/read pairs per cloud; confirm reads after an engine restart to prove durability.

### GCP (Firestore/GCS)
| resource_kind | write operation | read operation | location |
| --- | --- | --- | --- |
| event_spine | `python - <<'PY'\nfrom google.cloud import firestore\nc=firestore.Client(project='northstar-routing-prod')\nref=c.collection('event_spine').document('proof-event-spine-001')\nref.set({'value':'gcp-proof-event-spine-001'})\nprint('write-ok')\nPY` | `python - <<'PY'\nfrom google.cloud import firestore\nc=firestore.Client(project='northstar-routing-prod')\nprint(c.collection('event_spine').document('proof-event-spine-001').get().to_dict())\nPY` | Firestore collection event_spine |
| memory_store | write doc id `proof-memory-001` value `gcp-proof-memory-001` to collection memory_store | read same doc id | Firestore collection memory_store |
| blackboard_store | write doc id `proof-blackboard-001` value `gcp-proof-blackboard-001` | read same | Firestore collection blackboard_store |
| tabular_store | write doc id `proof-tabular-001` value `gcp-proof-tabular-001` | read same | Firestore collection tabular_store |
| analytics_store | write doc id `proof-analytics-001` value `gcp-proof-analytics-001` | read same | Firestore collection analytics_store |
| budget_store | write doc id `proof-budget-001` value `gcp-proof-budget-001` | read same | Firestore collection budget_store |
| notes_store | write doc id `proof-notes-001` value `gcp-proof-notes-001` | read same | Firestore collection notes_store |
| seo_config_store | write doc id `proof-seo-001` value `gcp-proof-seo-001` | read same | Firestore collection seo_config_store |
| object_store | `echo 'gcp-proof-object-001' | gsutil cp - gs://northstar-routing-objects/objects/proof-object-001.txt` | `gsutil cat gs://northstar-routing-objects/objects/proof-object-001.txt` | GCS bucket northstar-routing-objects/objects |
| media_output_store | `echo 'gcp-proof-media-001' | gsutil cp - gs://northstar-routing-media/media/proof-media-001.txt` | `gsutil cat gs://northstar-routing-media/media/proof-media-001.txt` | GCS bucket northstar-routing-media/media |

### AWS (DynamoDB/S3)
| resource_kind | write operation | read operation | location |
| --- | --- | --- | --- |
| event_spine | `aws dynamodb put-item --region us-east-1 --table-name event_spine --item '{\"pk\":{\"S\":\"proof#event_spine#001\"},\"sk\":{\"S\":\"v1\"},\"value\":{\"S\":\"aws-proof-event-spine-001\"}}'` | `aws dynamodb get-item --region us-east-1 --table-name event_spine --key '{\"pk\":{\"S\":\"proof#event_spine#001\"},\"sk\":{\"S\":\"v1\"}}'` | DynamoDB table event_spine |
| memory_store | write pk `proof#memory#001`, sk `v1`, value `aws-proof-memory-001` | get same key | DynamoDB table memory_store |
| blackboard_store | write pk `proof#blackboard#001`, sk `v1`, value `aws-proof-blackboard-001` | get same key | DynamoDB table blackboard_store |
| tabular_store | write pk `proof#tabular#001`, sk `v1`, value `aws-proof-tabular-001` | get same key | DynamoDB table tabular_store |
| analytics_store | write pk `proof#analytics#001`, sk `v1`, value `aws-proof-analytics-001` | get same key | DynamoDB table analytics_store |
| budget_store | write pk `proof#budget#001`, sk `v1`, value `aws-proof-budget-001` | get same key | DynamoDB table budget_store |
| notes_store | write pk `proof#notes#001`, sk `v1`, value `aws-proof-notes-001` | get same key | DynamoDB table notes_store |
| seo_config_store | write pk `proof#seo#001`, sk `v1`, value `aws-proof-seo-001` | get same key | DynamoDB table seo_config_store |
| object_store | `echo 'aws-proof-object-001' | aws s3 cp - s3://northstar-routing-objects-us-east-1/objects/proof-object-001.txt` | `aws s3 cp s3://northstar-routing-objects-us-east-1/objects/proof-object-001.txt -` | S3 bucket northstar-routing-objects-us-east-1/objects |
| media_output_store | `echo 'aws-proof-media-001' | aws s3 cp - s3://northstar-routing-media-us-east-1/media/proof-media-001.txt` | `aws s3 cp s3://northstar-routing-media-us-east-1/media/proof-media-001.txt -` | S3 bucket northstar-routing-media-us-east-1/media |

### Azure (Cosmos/Blob)
| resource_kind | write operation | read operation | location |
| --- | --- | --- | --- |
| event_spine | `python - <<'PY'\nfrom azure.cosmos import CosmosClient\nclient=CosmosClient('https://northstar-cosmos-prod.documents.azure.com','azure/northstar-routing-primary-key')\ncontainer=client.get_database_client('northstar-routing').get_container_client('event_spine')\ncontainer.upsert_item({'id':'proof-event-spine-001','pk':'proof-event-spine-001','value':'azure-proof-event-spine-001'})\nprint('write-ok')\nPY` | `python - <<'PY'\nfrom azure.cosmos import CosmosClient\nclient=CosmosClient('https://northstar-cosmos-prod.documents.azure.com','azure/northstar-routing-primary-key')\ncontainer=client.get_database_client('northstar-routing').get_container_client('event_spine')\nprint(container.read_item('proof-event-spine-001','proof-event-spine-001'))\nPY` | Cosmos DB container event_spine |
| memory_store | write id/pk `proof-memory-001`, value `azure-proof-memory-001` | read same | Cosmos DB container memory_store |
| blackboard_store | write id/pk `proof-blackboard-001`, value `azure-proof-blackboard-001` | read same | Cosmos DB container blackboard_store |
| tabular_store | write id/pk `proof-tabular-001`, value `azure-proof-tabular-001` | read same | Cosmos DB container tabular_store |
| analytics_store | write id/pk `proof-analytics-001`, value `azure-proof-analytics-001` | read same | Cosmos DB container analytics_store |
| budget_store | write id/pk `proof-budget-001`, value `azure-proof-budget-001` | read same | Cosmos DB container budget_store |
| notes_store | write id/pk `proof-notes-001`, value `azure-proof-notes-001` | read same | Cosmos DB container notes_store |
| seo_config_store | write id/pk `proof-seo-001`, value `azure-proof-seo-001` | read same | Cosmos DB container seo_config_store |
| object_store | `echo 'azure-proof-object-001' > /tmp/proof-object-001.txt\naz storage blob upload --account-name northstarroutingstore --container-name objects --name objects/proof-object-001.txt --file /tmp/proof-object-001.txt --auth-mode key --account-key "$(cat /path/to/azure/northstar-routing-storage-key)"` | `az storage blob download --account-name northstarroutingstore --container-name objects --name objects/proof-object-001.txt --file - --auth-mode key --account-key "$(cat /path/to/azure/northstar-routing-storage-key)"` | Blob container objects |
| media_output_store | `echo 'azure-proof-media-001' > /tmp/proof-media-001.txt\naz storage blob upload --account-name northstarroutingstore --container-name media --name media/proof-media-001.txt --file /tmp/proof-media-001.txt --auth-mode key --account-key "$(cat /path/to/azure/northstar-routing-storage-key)"` | `az storage blob download --account-name northstarroutingstore --container-name media --name media/proof-media-001.txt --file - --auth-mode key --account-key "$(cat /path/to/azure/northstar-routing-storage-key)"` | Blob container media |

Durability check: restart engines after writes, then re-run the read operations above; data must match the written proof values.

## 4) Failure Behavior
- event_spine: missing route -> emit attempts raise explicit routing error and block; no stdout fallback; warning surfaces in diagnostics.
- memory_store: missing route -> memory operations fail immediately; no in-memory downgrade; warning logged; startup reports missing route.
- blackboard_store: missing route -> coordination writes/reads rejected; no fallback.
- tabular_store: missing route -> save/load blocked; no local files.
- analytics_store: missing route -> ingest fails; diagnostics emit warnings; no memory fallback.
- budget_store: missing route -> budget enforcement blocks requests; no silent allow.
- notes_store: missing route -> notes create/read blocked; no in-memory/FS use.
- seo_config_store: missing route -> SEO config fetch/save fails; UI integrations must already block elsewhere; no defaults injected here.
- object_store: missing route -> uploads/downloads error; no local filesystem write.
- media_output_store: missing route -> media write/read errors; no filesystem fallback.
