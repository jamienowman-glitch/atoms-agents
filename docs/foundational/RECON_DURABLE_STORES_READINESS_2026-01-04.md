# Durable Stores Readiness (Recon) — 2026-01-04

| Req | Exists? | Evidence (paths/endpoints) | Risk | Missing pieces |
| --- | --- | --- | --- | --- |
| R1 — Uniform error envelope | Partial | `northstar-engines/engines/common/error_envelope.py` defines `{error:{code,message,gate,action_name,resource_kind,details}}` with no `error.http_status`; `engines/event_spine/routes.py` returns `{error_code,message}` not envelope; `engines/nexus/hardening/gate_chain.py` raises `HTTPException` with ad-hoc dicts; UI transport (`ui/packages/transport/src/index.ts`) throws raw status text on non-200. | Clients cannot rely on machine-readable codes or gate data; 410/503 handling diverges per endpoint. | Add `http_status` to canonical envelope and apply across actions/event_spine/budget/strategy_lock/canvas/chat/blackboard/memory; enforce 503 missing-route via shared helper; add tests for envelope parity. |
| R2 — Firearms policy store (routed) | No | Repo defaults to `InMemoryFirearmsRepository` (`engines/firearms/repository.py`); routes only `/firearms`, `/bindings`, `/grants` (`engines/firearms/routes.py`) with no routed backend or policy GET/PUT; GateChain still references undefined `DANGEROUS_ACTIONS` constant. | Firearms enforcement is code-driven and volatile; no tenant/surface scoping or restart durability; missing-route not surfaced. | Define `resource_kind=firearms_policy_store`, routed repo + schema for bindings/grants, endpoints `GET/PUT /firearms/policy` and `GET/PUT /firearms/grants`, GateChain lookup from store, 503 on missing route, multi-cloud adapters. |
| R3 — Strategy lock policy store | Partial | Strategy lock repo uses `resource_kind="strategy_lock_store"` via `VersionedStore` (`engines/strategy_lock/state.py`), but config repo is in-memory (`engines/strategy_lock/config_repository.py`); no policy endpoints; GateChain mixes firearms-derived requirements with lock resolution. | Locks/config not durable or discoverable; missing-route raises RuntimeError not error envelope; firearms/strategy coupling undefined. | Introduce `resource_kind=strategy_policy_store`, routed config + policy endpoints `GET/PUT /strategy-lock/policy`, consistent 503/410 envelopes, separation from firearms defaults, tests for replay after restart. |
| R4 — Chat durability (chat rail) | No | Chat bus defaults to runtime error when `CHAT_BUS_BACKEND=memory` and only supports Redis (`engines/chat/service/transport_layer.py`); no `chat_store` routing; timeline replay uses `event_stream` with hard-coded `tenant_id="t_system", env="dev"` (`engines/realtime/timeline.py`); chat HTTP route is stub echo (`engines/chat/service/routes.py`). | No durable transcript, no cursor-based replay, SSE relies on volatile memory/timeline; restart loses chat history; missing-route not detectable. | Add routed `chat_store` (append/list/snapshot) with 503 on missing route, 410 on invalid cursor, SSE backed by store replay, multi-cloud adapters, identity scoping (tenant/mode/project/thread/run/actor). |
| R5 — Config store (toggles) | No | No config endpoints or routed store in engines; strategy config uses in-memory repo; Agents client calls non-existent `registry/system-config` (`northstar-agents/src/northstar/engines_boundary/client.py`); toggles (e.g., `tool_canvas_mode`) default locally. | Platform toggles are hardcoded per process; UI/Agents cannot read authoritative settings; no multi-cloud routing; inconsistent behaviors across nodes. | Define `resource_kind=config_store` with `/config/{scope}` GET/PUT (scope=system|tenant|surface), routed adapters, 503 on missing route, docs for toggle keys. |
| R6 — Canvas correctness durability | No | Canvas commands use in-memory `CommandRepository` (`engines/canvas_commands/service.py`); `CanvasCommandStoreService` exists but unused; snapshot/replay reads the same in-memory list; timeline store routes with fixed tenant/env and raises RuntimeError on missing route (`engines/realtime/timeline.py`); SSE uses chat bus; invalid cursor detection is string-matching. UI relies on SSE + localStorage cache (`ui/packages/transport/src/index.ts`, `ui/packages/builder-core/src/index.ts`) with no GET `/replay` consumption or 410 handling. | Commands and cursors vanish on restart; optimistic concurrency and idempotency not durable; clients cannot recover gaps; error shape not uniform. | Wire `canvas_command_store` routing into apply_command/snapshot/replay, back timeline with routed `event_stream`, add GET `/replay` with 410 envelope, remove in-memory/default storage, ensure SSE resumes from durable cursor; update UI transport/kernel for replay + 410 handling. |

Doc mismatches: `docs/foundational/NORTHSTAR_TECHNICAL_SPEC.md` promises routed canvas command store + snapshot/replay and durable chat rail, but current code paths are in-memory/stubbed as above.
