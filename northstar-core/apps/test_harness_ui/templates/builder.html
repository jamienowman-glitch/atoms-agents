<!DOCTYPE html>
<html>

<head>
    <title>Northstar Flow Builder</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            background: #222;
            color: #eee;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background: #333;
            padding: 10px 20px;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            margin: 0;
            font-size: 1.2em;
            color: #0f0;
        }

        a {
            color: #8af;
            text-decoration: none;
            margin-right: 20px;
        }

        #container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Palette */
        #palette {
            width: 280px;
            background: #1a1a1a;
            border-right: 1px solid #444;
            padding: 10px;
            overflow-y: auto;
        }

        .section-title {
            font-size: 0.9em;
            font-weight: bold;
            color: #aaa;
            margin: 15px 0 5px 0;
            border-bottom: 1px solid #333;
        }

        .draggable {
            background: #333;
            border: 1px solid #555;
            padding: 8px;
            margin-bottom: 5px;
            cursor: grab;
            border-radius: 4px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .draggable:hover {
            background: #444;
            border-color: #888;
        }

        .draggable.framework {
            border-left: 4px solid #f60;
        }

        .draggable.agent {
            border-left: 4px solid #0f0;
        }

        /* Canvas */
        #canvas {
            flex: 1;
            background: #111;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        #drop-zone {
            width: 100%;
            max-width: 600px;
            min-height: 400px;
            border: 2px dashed #333;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 20px;
            align-items: center;
        }

        #drop-zone.dragover {
            background: #1a1a1a;
            border-color: #0f0;
        }

        .empty-msg {
            color: #555;
            margin-top: 100px;
        }

        /* Flow Blocks */
        .flow-step {
            width: 100%;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 10px;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .flow-step h3 {
            margin: 0;
            font-size: 1em;
            color: #f60;
            display: flex;
            justify-content: space-between;
        }

        .remove-btn {
            color: #f44;
            cursor: pointer;
            font-size: 0.8em;
        }

        .agent-slot {
            background: #111;
            border: 1px dashed #555;
            padding: 10px;
            min-height: 40px;
            border-radius: 4px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            align-items: center;
        }

        .agent-slot.dragover {
            border-color: #0f0;
            background: #161616;
        }

        .slotted-agent {
            background: #004400;
            border: 1px solid #0f0;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .slot-label {
            color: #666;
            font-size: 0.8em;
            width: 100%;
            text-align: center;
        }

        .config-row {
            display: flex;
            gap: 10px;
            font-size: 0.8em;
            color: #aaa;
        }

        input {
            background: #111;
            border: 1px solid #444;
            color: #eee;
            padding: 4px;
            border-radius: 3px;
            width: 100px;
        }

        button.action {
            padding: 8px 15px;
            background: #0066cc;
            border: none;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        button.action:hover {
            background: #0077dd;
        }

        .io-slot {
            flex: 1;
            background: #111;
            border: 1px dashed #666;
            padding: 8px;
            font-size: 0.8em;
            color: #777;
            text-align: center;
            border-radius: 4px;
            cursor: pointer;
        }

        .io-slot.dragover {
            border-color: #0f0;
            background: #1a1a1a;
        }

        .chat-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Toggle Switch */
        .mode-switch {
            display: flex;
            align-items: center;
            background: #222;
            border-radius: 20px;
            padding: 2px;
            border: 1px solid #444;
            cursor: pointer;
            width: 120px;
            position: relative;
        }

        .mode-switch .option {
            flex: 1;
            text-align: center;
            font-size: 0.8em;
            color: #666;
            z-index: 2;
            transition: color 0.3s;
        }

        .mode-switch .slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 50%;
            height: calc(100% - 4px);
            background: #444;
            border-radius: 18px;
            transition: all 0.3s;
            z-index: 1;
        }

        .mode-switch.planning .slider {
            left: 2px;
            background: #007bff;
        }

        .mode-switch.building .slider {
            left: 50%;
            background: #28a745;
        }

        .mode-switch.planning .option.plan {
            color: #fff;
            font-weight: bold;
        }

        .mode-switch.building .option.build {
            color: #fff;
            font-weight: bold;
        }

        /* Chat Rail Styles */
        #chat-rail {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            height: 500px;
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.6);
            z-index: 1000;
            resize: both;
            overflow: hidden;
            min-width: 300px;
            min-height: 200px;
        }

        #chat-header {
            padding: 10px;
            background: #333;
            border-bottom: 1px solid #444;
            font-weight: bold;
            border-radius: 8px 8px 0 0;
            cursor: move;
            /* Drag Handle */
            flex-shrink: 0;
        }

        #chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            font-size: 0.9em;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: #111;
        }

        #chat-input-area {
            padding: 10px;
            display: flex;
            gap: 5px;
            border-top: 1px solid #444;
            flex-shrink: 0;
            background: #222;
        }

        #chat-input-area input {
            flex: 1;
        }

        .msg {
            padding: 8px;
            border-radius: 4px;
            max-width: 85%;
            word-wrap: break-word;
        }

        .msg.user {
            align-self: flex-end;
            background: #004400;
            color: #cfc;
        }

        .msg.bot {
            align-self: flex-start;
            background: #333;
            color: #ddd;
        }

        /* Mobile View: Bottom Sheet */
        @media (max-width: 768px) {
            #chat-rail {
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                top: auto !important;
                /* Override drag */
                width: 100% !important;
                height: auto;
                max-height: 90vh;
                /* Full expand limit */
                border-radius: 12px 12px 0 0;
                resize: none;
                transition: height 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            }

            /* States handled by JS classes */
            #chat-rail.mobile-min {
                height: 60px;
                /* Only header/input */
                overflow: hidden;
            }

            #chat-rail.mobile-half {
                height: 50vh;
            }

            #chat-rail.mobile-full {
                height: 90vh;
            }

            #chat-header {
                cursor: pointer;
                /* Tap to expand */
            }

            #chat-header::after {
                content: "";
                display: block;
                width: 40px;
                height: 4px;
                background: #555;
                margin: 5px auto 0;
                border-radius: 2px;
            }
        }
    </style>
</head>


<body>
    <header>
        <div style="display:flex; align-items:center;">
            <a href="/">&laquo; Back</a>
            <a href="/simulator" style="margin-left:20px; color:#f60;">Simulator</a>
            <h1 style="margin-left:20px;">Visual Flow Builder</h1>
        </div>
        <div>
            <button class="action" onclick="importFlow()"
                style="background:#446; border-color:#558; margin-right:10px;">LOAD FLOW</button>
            <button class="action" onclick="exportFlow()">EXPORT & SAVE FLOW</button>
        </div>
    </header>

    <!-- Chat Rail -->
    <div id="chat-rail">
        <div id="chat-header">
            <div class="chat-header-row">
                <span>Builder Co-Pilot ü§ñ</span>
            </div>
            <div style="margin-top:10px; display:flex; justify-content:center; color:#666; font-size:0.8em;">
                <em>AI & Drag-Drop Both Active</em>
            </div>
        </div>
        <div id="chat-history"></div>
        <div id="chat-input-area">
            <input type="text" id="chat-input" placeholder="Discuss the plan..."
                onkeydown="if(event.key==='Enter') sendChat()">
            <button onclick="sendChat()">Send</button>
        </div>
    </div>



    <div id="container">
        <!-- Palette -->
        <div id="palette">
            <div class="section-title">FRAMEWORKS</div>

            <div class="draggable framework" draggable="true" ondragstart="drag(event)" data-type="framework"
                data-id="crewai">
                <span>CrewAI (Single)</span> <span>ü§ñ</span>
            </div>

            <div class="draggable framework" draggable="true" ondragstart="drag(event)" data-type="framework"
                data-id="autogen">
                <span>AutoGen (Group)</span> <span>üí¨</span>
            </div>

            <div class="draggable framework" draggable="true" ondragstart="drag(event)" data-type="standalone"
                data-id="standalone" style="border-left: 4px solid #fff;">
                <span>Standalone Agent</span> <span>üë§</span>
            </div>

            <div class="section-title">AGENTS</div>
            <div id="agent-list">Loading...</div>

            <div class="section-title">DATA</div>
            <div class="draggable data-block" draggable="true" ondragstart="drag(event)" data-type="data"
                data-id="user_input" style="border-left: 4px solid #cc0;">
                <span>User Input (Start)</span> <span>keyboard</span>
            </div>
            <div class="draggable data-block" draggable="true" ondragstart="drag(event)" data-type="data"
                data-id="html_page" style="border-left: 4px solid #00f;">
                <span>HTML Page</span> <span>code</span>
            </div>
            <div class="draggable data-block" draggable="true" ondragstart="drag(event)" data-type="data"
                data-id="report" style="border-left: 4px solid #00f;">
                <span>Text Report</span> <span>description</span>
            </div>
            <div class="draggable data-block" draggable="true" ondragstart="drag(event)" data-type="data"
                data-id="user_image" style="border-left: 4px solid #cc0;">
                <span>Uploaded Image</span> <span>image</span>
            </div>
            <div class="draggable data-block" draggable="true" ondragstart="drag(event)" data-type="data"
                data-id="user_image" style="border-left: 4px solid #cc0;">
                <span>Uploaded Image</span> <span>image</span>
            </div>

            <div class="section-title">LOGIC</div>
            <div class="draggable framework" draggable="true" ondragstart="drag(event)" data-type="router"
                data-id="human_router" style="border-left: 4px solid #f0f;">
                <span>Router (Human Loop)</span> <span>üîÄ</span>
            </div>
        </div>

        <!-- Canvas -->
        <div id="canvas">
            <div id="drop-zone" ondrop="dropOnCanvas(event)" ondragover="allowDrop(event)">
                <div class="empty-msg">Drag Framework Blocks Here</div>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="import-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:2000; justify-content:center; align-items:center;">
        <div style="background:#222; padding:20px; border:1px solid #444; border-radius:8px; width:400px;">
            <h3 style="margin-top:0;">Load Existing Flow</h3>
            <select id="import-select"
                style="width:100%; padding:10px; background:#111; color:#eee; border:1px solid #555; margin-bottom:15px;">
                <option>Loading...</option>
            </select>
            <div style="text-align:right;">
                <button onclick="document.getElementById('import-modal').style.display='none'"
                    style="margin-right:10px;">Cancel</button>
                <button class="primary" onclick="confirmImport()">LOAD</button>
            </div>
        </div>
    </div>
    <script>
        const dropZone = document.getElementById('canvas');
        let stepCounter = 1;

        // --- Drag and Drop Logic ---
        let draggedAgent = null;

        function drag(event) {
            draggedAgent = event.target;
        }

        function allowDrop(event) {
            event.preventDefault();
        }

        function drop(event) {
            event.preventDefault();

            if (draggedAgent) {
                const slot = event.target.closest('.agent-slot');

                if (slot) {
                    addAgentToSlot(slot, draggedAgent.dataset.agentId);
                }
            }

            draggedAgent = null;
        }

        function addAgentToSlot(slot, agentId) {
            // Check if agent already exists in this slot
            const existingAgents = Array.from(slot.querySelectorAll('.slotted-agent')).map(a => a.dataset.agentId);

            if (existingAgents.includes(agentId)) {
                console.log(`Agent ${agentId}

                        already exists in this slot.`);
                return;
            }

            const pill = document.createElement('div');
            pill.className = 'slotted-agent';
            pill.dataset.agentId = agentId;

            // Check if it's a manager agent (only for CrewAI)
            const parentStep = slot.closest('.flow-step');
            let managerHtml = '';

            if (parentStep && parentStep.dataset.framework === 'crewai') {
                managerHtml = ` <input type="checkbox" class="manager-check" title="Is Manager?">`;
            }

            pill.innerHTML = `<span onclick="window.open('/agents?file=${agentId}', '_blank')" style="cursor:pointer; border-bottom:1px solid #0f0; color:#fff;">${agentId}

                            </span>${managerHtml}

                            <span style="cursor:pointer; margin-left:5px; color:#f44;" onclick="this.parentElement.remove()">x</span>`;

            slot.appendChild(pill);
        }

        // --- Step Management Logic ---
        function createStep(framework = 'standalone') {
            const step = document.createElement('div');
            step.className = 'flow-step';

            step.dataset.stepId = `step_${stepCounter++}

                            `;
            step.dataset.framework = framework;

            let frameworkOptions = ` <option value="standalone" ${framework === 'standalone' ? 'selected' : ''}

                            >Standalone</option><option value="crewai" ${framework === 'crewai' ? 'selected' : ''}

                            >CrewAI</option><option value="autogen" ${framework === 'autogen' ? 'selected' : ''}

                            >AutoGen</option><option value="router" ${framework === 'router' ? 'selected' : ''}

                            >Router</option>`;

            step.innerHTML = ` <div class="step-header"><span class="step-id">${step.dataset.stepId}

                            </span><select class="framework-select" onchange="updateStepFramework(this)">${frameworkOptions}

                                </select><span class="delete-step" onclick="this.closest('.flow-step').remove()">x</span></div><div class="step-content"><div class="io-section"><div class="io-slot" data-slot-type="in" onclick="showIOSlotMenu(this)">Input</div><div class="io-slot" data-slot-type="out" onclick="showIOSlotMenu(this)">Output</div></div><div class="agent-slot" ondrop="drop(event)" ondragover="allowDrop(event)">Drop Agents Here </div><div class="router-config" style="display:${framework === 'router' ? 'block' : 'none'};">Reject Target: <select class="router-target-select"></select></div></div>`;
            dropZone.appendChild(step);
            updateRouterTargets(); // Update targets for all router steps
            return step;
        }

        function updateStepFramework(selectElement) {
            const step = selectElement.closest('.flow-step');
            const oldFramework = step.dataset.framework;
            const newFramework = selectElement.value;
            step.dataset.framework = newFramework;

            const agentSlot = step.querySelector('.agent-slot');
            const routerConfig = step.querySelector('.router-config');

            // Clear agents if framework changes from multi-agent to standalone
            if (oldFramework !== 'standalone' && newFramework === 'standalone') {
                agentSlot.innerHTML = 'Drop Agents Here';
            }

            // Show/hide manager checkbox
            const managerChecks = step.querySelectorAll('.manager-check');

            managerChecks.forEach(checkbox => {
                if (newFramework === 'crewai') {
                    checkbox.style.display = 'inline-block';
                }

                else {
                    checkbox.style.display = 'none';
                    checkbox.checked = false; // Uncheck if not CrewAI
                }
            });

            // Show/hide router config
            if (newFramework === 'router') {
                routerConfig.style.display = 'block';
                updateRouterTargets();
            }

            else {
                routerConfig.style.display = 'none';
            }
        }

        function updateRouterTargets() {
            const routerSteps = document.querySelectorAll('.flow-step[data-framework="router"]');
            const allStepIds = Array.from(document.querySelectorAll('.flow-step')).map(s => s.dataset.stepId);

            routerSteps.forEach(routerStep => {
                const select = routerStep.querySelector('.router-target-select');
                const currentSelected = select.value; // Preserve selection if possible
                select.innerHTML = '<option value="">(End Flow)</option>'; // Default option

                allStepIds.forEach(stepId => {
                    if (stepId !== routerStep.dataset.stepId) {
                        // A router cannot target itself
                        const option = document.createElement('option');
                        option.value = stepId;
                        option.innerText = stepId;
                        select.appendChild(option);
                    }
                });
                select.value = currentSelected; // Restore selection
            });
        }

        // --- I/O Slot Menu Logic ---
        let currentIOSlot = null;

        function showIOSlotMenu(slot) {
            currentIOSlot = slot;
            const menu = document.getElementById('io-slot-menu');
            menu.style.display = 'block';

            menu.style.left = `${slot.getBoundingClientRect().left}

                            px`;

            menu.style.top = `${slot.getBoundingClientRect().bottom + 5}

                            px`;
        }

        function setSlotValue(slot, value, name) {
            slot.dataset.value = value;
            slot.innerText = name;
            document.getElementById('io-slot-menu').style.display = 'none';
        }

        // --- Agent Sidebar Logic ---
        async function loadAgents() {
            const agentList = document.getElementById('agent-list');
            agentList.innerHTML = 'Loading agents...';

            try {
                const res = await fetch('/api/registry/agents');
                const data = await res.json();
                agentList.innerHTML = ''; // Clear loading message

                data.agents.forEach(agent => {
                    const agentDiv = document.createElement('div');
                    agentDiv.className = 'agent-item';
                    agentDiv.draggable = true;
                    agentDiv.dataset.agentId = agent.filename;
                    agentDiv.ondragstart = drag;

                    agentDiv.innerHTML = ` <span onclick="window.open('/agents?file=${agent.filename}', '_blank')" style="cursor:pointer; border-bottom:1px solid #0f0; color:#fff;" >${agent.display_name}

                            </span> `;
                    agentList.appendChild(agentDiv);
                });
            }

            catch (e) {
                agentList.innerHTML = 'Error loading agents.';
                console.error("Error loading agents:", e);
            }
        }

        // --- Export Logic ---
        async function exportFlow() {
            const steps = [];
            // Prompt User for Name
            let flowName = prompt("Enter a name for this Flow (e.g., my_awesome_flow):", "custom_flow");
            if (!flowName) return; // Cancelled
            if (!flowName.endsWith('.yaml')) flowName += ".yaml";

            const blocks = dropZone.querySelectorAll('.flow-step');

            if (blocks.length === 0) {
                alert("Add some steps first!");
                return;
            }

            blocks.forEach((block, index) => {
                const stepId = block.dataset.stepId;
                const fw = block.dataset.framework;

                // Look ahead for "next" (default linear)
                let nextStepId = null;

                if (index < blocks.length - 1) {
                    nextStepId = blocks[index + 1].dataset.stepId;
                }

                if (fw === 'router') {
                    const rejectTarget = block.querySelector('.router-target-select').value;

                    steps.push({

                        id: stepId,
                        type: "router",
                        // Default path is "approve" -> next step
                        next: nextStepId,
                        routes: {
                            reject: rejectTarget || null, // Loop path
                            approve: nextStepId
                        }
                    });
                    return;
                }

                const agents = Array.from(block.querySelectorAll('.slotted-agent')).map(a => {
                    return {
                        id: a.dataset.agentId,
                        isManager: a.querySelector('.manager-check')?.checked
                    }

                        ;
                });

                // Read from Data Slots
                const inputSlot = block.querySelector('.io-slot[data-slot-type="in"]');
                const outputSlot = block.querySelector('.io-slot[data-slot-type="out"]');

                const inputVal = inputSlot.dataset.value;
                const outputVal = outputSlot.dataset.value;

                // Defaults
                let inputs = [];

                let outputs = [`output_${stepId}

                            `];
                let expected_output = null;

                // Logic Mapping for Input
                if (inputVal === 'user_input') {
                    inputs = ["input_text"];
                }

                else if (inputVal === 'user_image') {
                    inputs = ["input_image", "input_text"]; // Support multimodal
                }

                else if (inputVal) {
                    inputs = [inputVal]; // Future proofing
                }

                else {
                    inputs = [`input_${stepId}

                        `];
                }

                // Logic Mapping for Output
                if (outputVal === 'html_page') {
                    expected_output = "Generate the full HTML code for a modern, responsive webpage. Ensure it is complete with CSS and valid HTML5 structure. Do not use external CSS files, embed CSS in <style>.";

                    outputs = [`${flowName}

                            _page.html`];
                }

                else if (outputVal === 'report') {
                    expected_output = "Write a detailed professional report (approx 500 words) summarizing the findings. Use Markdown formatting.";
                }

                if (agents.length === 0) return; // Skip empty steps

                const stepObj = {
                    id: stepId,
                    inputs: inputs,
                    outputs: outputs,
                    next: nextStepId // Explicit next pointer
                }

                    ;

                if (expected_output) {
                    stepObj.expected_output = expected_output;
                }

                if (fw === 'standalone') {
                    // Standalone: agent_id directly, no Generic Flow
                    stepObj.agent_id = "registry/agents/" + agents[0].id;
                    stepObj.flow_id = "registry/agents/" + agents[0].id; // Trick main.py logic

                }

                else if (fw === 'crewai') {
                    // Use Generic Flow
                    stepObj.flow_id = "registry/flows/crewai/flow_generic.yaml";

                    // Multi-Agent Override
                    stepObj.crew_agents = agents.map(a => ({
                        agent_id: "registry/agents/" + a.id
                    }));

                    // Manager Override
                    const mgr = agents.find(a => a.isManager);

                    if (mgr) {
                        stepObj.manager_agent_id = "registry/agents/" + mgr.id;
                    }

                }

                else if (fw === 'autogen') {
                    // Use Generic Flow + Participants Override
                    stepObj.flow_id = "registry/flows/autogen/flow_generic.yaml";

                    stepObj.participants = agents.map(a => ({
                        id: a.id.replace('.yaml', ''), // Short ID
                        agent_id: "registry/agents/" + a.id // Full Path
                    }));
                }

                steps.push(stepObj);
            });

            const yamlContent = `name: ${flowName}

                            id: registry/flows/manual/${flowName}

                            description: "Generated by Visual Builder"

                            steps: ${steps.map(s => {
                if (s.type === 'router') {

                    // Router Step YAML
                    let y = ` - id: ${s.id}

                            \n type: router\n`;

                    if (s.routes) {
                        y += ` routes:\n`;

                        if (s.routes.reject) y += ` reject: ${s.routes.reject}

                                \n`;

                        if (s.routes.approve) y += ` approve: ${s.routes.approve}

                                \n`;
                    }

                    if (s.next) y += ` next: ${s.next}

                            \n`;
                    return y;
                }

                // Normal Step YAML
                let y = ` - id: ${s.id}

                        \n flow_id: ${s.flow_id}

                        \n`;

                if (s.next) y += ` next: ${s.next}

                        \n`;

                // Standalone / Standard
                if (s.agent_id) y += ` agent_id: ${s.agent_id}

                        \n`;

                // CrewAI
                if (s.crew_agents) {
                    y += ` crew_agents:\n`;

                    s.crew_agents.forEach(a => {
                        y += ` - agent_id: ${a.agent_id}

                                    \n`;
                    });
                }

                if (s.manager_agent_id) {
                    y += ` manager_agent_id: ${s.manager_agent_id}

                            \n`;
                }

                // AutoGen
                if (s.participants) {
                    y += ` participants:\n`;

                    s.participants.forEach(p => {
                        y += ` - id: ${p.id}

                                    \n agent_id: ${p.agent_id}

                                    \n`;
                    });
                }

                y += ` inputs: [${s.inputs}

                        ]\n`;

                y += ` outputs: [${s.outputs}

                        ]\n`;

                if (s.expected_output) {
                    y += ` expected_output: ${JSON.stringify(s.expected_output)} \n`;
                }

                return y;
            }).join('')
                }

                            `;

            try {

                // Ensure directory exists - we'll put it in 'manual'
                // Use existing API which saves to path relative to FLOW_REGISTRY_DIR
                const res = await fetch('/api/registry/flows/content', {

                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }

                    ,
                    body: JSON.stringify({
                        filename: "manual/" + flowName,
                        content: yamlContent
                    })
                });

                const data = await res.json();
                if (data.error) throw new Error(data.error);

                alert("Flow Saved: " + flowName);
                window.location.href = "/"; // Go back to runner to use it
            }

            catch (e) {
                alert("Error saving: " + e.message);
            }
        }

        // --- Import Logic ---
        async function importFlow() {
            const modal = document.getElementById('import-modal');
            const select = document.getElementById('import-select');

            modal.style.display = 'flex';
            select.innerHTML = '<option>Loading...</option>';

            try {
                const res = await fetch('/api/registry/flows');
                const data = await res.json();

                select.innerHTML = '';

                data.flows.forEach(f => {
                    const opt = document.createElement('option');
                    // Helper to prioritize 'manual/' flows or show them nicely
                    opt.value = f.filename;
                    opt.innerText = f.display_name;
                    select.appendChild(opt);
                });
            }

            catch (e) {
                select.innerHTML = '<option>Error loading flows</option>';
            }
        }

        async function confirmImport() {
            const select = document.getElementById('import-select');
            const filename = select.value;
            if (!filename) return;

            document.getElementById('import-modal').style.display = 'none';

            // Clear Canvas
            dropZone.innerHTML = "";
            stepCounter = 1;

            try {
                const res = await fetch('/api/builder/import', {

                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }

                    ,
                    body: JSON.stringify({
                        filename: filename
                    })
                });

                const data = await res.json();
                if (data.error) throw new Error(data.error);

                if (data.actions) {
                    await executeActions(data.actions);
                    // alert("Imported Successfully!"); // Less noisy
                }

            }

            catch (e) {
                alert("Import Failed: " + e.message);
            }
        }


        // --- Chat Rail Logic ---
        let chatMode = 'mixed'; // Unified Mode

        // Init Drag - Ensure elements exist before accessing
        const rail = document.getElementById('chat-rail');
        if (rail) {
            dragElement(rail);

            // Init Mobile State
            if (window.innerWidth <= 768) {
                rail.classList.add('mobile-half');
                const header = document.getElementById('chat-header');
                if (header) {
                    header.addEventListener('click', (e) => {
                        if (e.target.closest('.mode-switch')) return;
                        if (window.innerWidth > 768) return;

                        if (rail.classList.contains('mobile-min')) {
                            rail.classList.remove('mobile-min');
                            rail.classList.add('mobile-half');
                        } else if (rail.classList.contains('mobile-half')) {
                            rail.classList.remove('mobile-half');
                            rail.classList.add('mobile-full');
                        } else {
                            rail.classList.remove('mobile-full');
                            rail.classList.add('mobile-min');
                        }
                    });
                }
            }
        }

        function dragElement(elmnt) {
            if (!elmnt) return;
            if (window.innerWidth <= 768) return;

            var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            const header = document.getElementById("chat-header");
            if (header) {
                header.onmousedown = dragMouseDown;
            }

            function dragMouseDown(e) {
                e = e || window.event;
                if (['INPUT', 'BUTTON', 'DIV'].includes(e.target.tagName) && e.target.closest('.mode-switch')) return;

                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;

                elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
                elmnt.style.bottom = "auto";
                elmnt.style.right = "auto";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        // Removed toggleMode() - Drag and Chat are always active.

        async function sendChat() {
            const input = document.getElementById('chat-input');
            const history = document.getElementById('chat-history');
            if (!input || !history) return;

            const msg = input.value.trim();
            if (!msg) return;

            // User Msg
            const userDiv = document.createElement('div');
            userDiv.className = 'msg user';
            userDiv.innerText = msg;
            history.appendChild(userDiv);
            input.value = "";
            history.scrollTop = history.scrollHeight;

            // Loading
            const loadDiv = document.createElement('div');
            loadDiv.className = 'msg bot';
            loadDiv.innerText = "...";
            history.appendChild(loadDiv);

            try {
                // Gather Context
                const currentSteps = Array.from(document.querySelectorAll('.flow-step')).map(s => {
                    const slotted = Array.from(s.querySelectorAll('.slotted-agent')).map(a => a.dataset.agentId);
                    return {
                        id: s.dataset.stepId,
                        framework: s.dataset.framework,
                        agents: slotted
                    };
                });

                const res = await fetch('/api/builder/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: msg,
                        mode: chatMode,
                        current_flow: currentSteps,
                        chat_history: history.innerText // Send full context
                    })
                });

                const data = await res.json();
                loadDiv.innerText = data.thought || "Done.";

                if (data.actions) {
                    await executeActions(data.actions);
                }

            } catch (e) {
                console.error(e);
                loadDiv.innerText = "Error: " + e.message;
            }
        }

        async function executeActions(actions) {
            const history = document.getElementById('chat-history');

            for (const act of actions) {
                console.log("Executing:", act);
                await new Promise(r => setTimeout(r, 600));

                try {
                    if (act.cmd === 'add_step') {
                        if (typeof createStep === 'function') {
                            const step = createStep(act.framework);
                            step.dataset.stepId = act.id;
                            step.scrollIntoView({ behavior: 'smooth' });
                        }
                    } else if (act.cmd === 'add_agent') {
                        const step = document.querySelector(`.flow-step[data-step-id="${act.step_id}"]`);
                        if (step) {
                            const slot = step.querySelector('.agent-slot');
                            if (typeof addAgentToSlot === 'function') {
                                addAgentToSlot(slot, act.agent_id);
                            }
                            const pill = slot.lastElementChild;
                            if (pill) {
                                pill.style.border = "2px solid #fff";
                                setTimeout(() => pill.style.border = "1px solid #0f0", 500);
                            }
                        }
                    } else if (act.cmd === 'create_agent') {
                        const payload = {
                            filename: act.filename,
                            display_name: act.role,
                            role: act.role,
                            manifest: act.goal,
                            persona: act.backstory,
                            framework: "crewai"
                        };

                        const res = await fetch('/api/registry/agents', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (res.ok) {
                            if (typeof loadAgents === 'function') await loadAgents();
                            const div = document.createElement('div');
                            div.className = 'msg bot';
                            div.style.color = '#0f0';
                            div.innerText = `‚úÖ Created New Agent: ${act.filename}`;
                            history.appendChild(div);
                        }
                    } else if (act.cmd === 'set_io') {
                        const step = document.querySelector(`.flow-step[data-step-id="${act.step_id}"]`);
                        if (step) {
                            const slot = step.querySelector(`.io-slot[data-slot-type="${act.type}"]`);
                            const name = act.block === 'user_input' ? 'User Input' :
                                act.block === 'html_page' ? 'HTML Page' : act.block === 'report' ? 'Text Report' : act.block;
                            if (typeof setSlotValue === 'function') {
                                setSlotValue(slot, act.block, name);
                            }
                        }
                    } else if (act.cmd === 'build_swarm') {
                        const div = document.createElement('div');
                        div.className = 'msg bot';
                        div.style.color = '#f60';
                        div.innerHTML = `
                            <strong>üöÄ Agent Factory Activated</strong><br>
                            I have sent the Blueprint to the Factory Foreman.<br>
                            <button onclick="window.location.href='/simulator?auto_start=true'" style="margin-top:10px; padding:8px; background:#f60; color:#fff; border:none; cursor:pointer;">Watch Build in Simulator &raquo;</button>
                        `;
                        history.appendChild(div);

                        // Trigger Factory Flow
                        await fetch('/api/run/start', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                flow_id: "registry/flows/meta/flow_factory_construction.yaml",
                                inputs: { blueprint: act.blueprint },
                                framework_override: null
                            })
                        });
                    }
                } catch (e) {
                    console.error("Action Failed:", act, e);
                    const errDiv = document.createElement('div');
                    errDiv.className = 'msg bot';
                    errDiv.style.color = '#f44';
                    errDiv.innerText = `‚ùå Action Failed: ${e.message}`;
                    history.appendChild(errDiv);
                }
            }
        }
    </script>
</body>

</html>