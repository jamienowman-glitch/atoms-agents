<!DOCTYPE html>
<html>

<head>
    <title>Northstar Test Harness</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #222;
            color: #eee;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .panel {
            background: #333;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }

        h2 {
            margin-top: 0;
        }

        label {
            display: block;
            margin-bottom: 5px;
        }

        #log-area {
            height: 500px;
            overflow-y: scroll;
            background: #111;
            padding: 10px;
            border: 1px solid #444;
            font-size: 13px;
        }

        /* Log Table Styling */
        .log-table {
            width: 100%;
            border-collapse: collapse;
        }

        .log-table td {
            padding: 4px 8px;
            vertical-align: top;
        }

        .col-meta {
            width: 180px;
            color: #888;
            border-right: 1px solid #333;
        }

        .col-content {
            padding-left: 10px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .badge {
            display: inline-block;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            margin-right: 5px;
        }

        .badge-info {
            background: #444;
            color: #aaa;
        }

        .badge-output {
            background: #004400;
            color: #0f0;
        }

        .badge-error {
            background: #660000;
            color: #f00;
        }

        .badge-write {
            background: #000066;
            color: #aaf;
        }

        .badge-cancelled {
            background: #775500;
            color: #fff;
        }

        a.agent-link {
            color: #8af;
            text-decoration: none;
            border-bottom: 1px dotted #555;
        }

        a.agent-link:hover {
            color: #fff;
            border-bottom: 1px solid #fff;
        }

        button {
            padding: 8px 15px;
            cursor: pointer;
            background: #444;
            color: #fff;
            border: 1px solid #555;
            border-radius: 3px;
        }

        button:hover {
            background: #555;
        }

        button.primary {
            background: #2a6;
            border-color: #184;
        }

        button.stop {
            background: #c33;
            border-color: #822;
            margin-left: 10px;
        }

        .artifact-link {
            color: #fa0;
            margin-left: 10px;
            text-decoration: none;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="container">
        <div style="text-align: right; margin-bottom: 20px;">
            <a href="/builder"
                style="color: #f60; font-weight: bold; text-decoration: none; padding: 10px; border: 1px solid #f60; border-radius: 4px; margin-right: 10px;">&oplus;
                VISUAL BUILDER</a>
            <a href="/agents"
                style="color: #0f0; font-weight: bold; text-decoration: none; padding: 10px; border: 1px solid #0f0; border-radius: 4px;">&rarr;
                CONFIGURE AGENTS</a>
        </div>
        <div class="panel">
            <h2>Start New Run</h2>
            <form id="runForm">
                <label>Flow Definition:</label>
                <label>Flow Definition Path:</label>
                <input list="flowSuggestions" id="flowPath" name="flowPath"
                    style="width: 100%; margin-bottom: 10px; padding: 5px; background: #222; color: #fff; border: 1px solid #555;"
                    value="registry/flows/langgraph/flow_youtube_orchestrator.yaml">
                <datalist id="flowSuggestions">
                    <option value="registry/flows/langgraph/flow_youtube_orchestrator.yaml">
                    <option value="registry/flows/crewai/flow_youtube_spanish_team.yaml">
                </datalist>

                <label>Input File (Report) OR Raw Text:</label>
                <input type="file" id="inputFile" name="inputFile" style="margin-bottom: 5px;">
                <div style="font-size: 0.8em; color: #888; margin-bottom: 5px;">- OR -</div>
                <textarea id="inputText" name="inputText" placeholder="Paste report content here..."
                    style="width: 100%; height: 60px; background: #222; color: #eee; border: 1px solid #555; margin-bottom: 10px;"></textarea>

                <br>
                <button type="submit" class="primary">START RUN</button>
                <button type="button" id="stopBtn" class="stop" disabled>STOP RUN</button>
            </form>
            <div id="status" style="margin-top: 10px; color: #fa0;"></div>
        </div>

        <div class="panel">
            <h2>Live Logs</h2>
            <div id="log-area">
                <table class="log-table" id="logTable">
                    <!-- Logs go here -->
                </table>
            </div>
        </div>

        <div class="panel">
            <h2>Artifacts</h2>
            <ul id="artifact-list">
                <!-- Links will appear here -->
            </ul>
        </div>
    </div>

    <script>
        let currentRunId = null;
        const form = document.getElementById('runForm');
        const statusDiv = document.getElementById('status');
        const logTable = document.getElementById('logTable');
        const artifactList = document.getElementById('artifact-list');
        const stopBtn = document.getElementById('stopBtn');

        // Dynamic Flow Loading
        async function loadFlows() {
            try {
                const res = await fetch('/api/registry/flows');
                const data = await res.json();
                const datalist = document.getElementById('flowSuggestions');
                datalist.innerHTML = ""; // Clear hardcoded
                
                data.flows.forEach(f => {
                    const opt = document.createElement('option');
                    // Ensure full path relative to repo or how start_run expects it
                    // The API returns 'id' as relative path from REGISTRY_DIR
                    // But start_run expects 'registry/flows/...'?
                    // Let's check main.py. start_run uses flow_path directly.
                    // If flow_path is relative, _load_flow_content joins it with REPO_ROOT.
                    // The API returns 'manual/foo.yaml'.
                    // So we probably need to prepend 'registry/flows/' to match REPO_ROOT structure
                    // OR just rely on _load_flow_content handling it. 
                    // Let's look at main.py again. _load_flow_content: if not absolute, join REPO_ROOT, path.
                    // If path is "manual/foo.yaml", it becomes "REPO/manual/foo.yaml" -> WRONG.
                    // REGISTRY_DIR is "REPO/registry/flows".
                    // So we need to prepend "registry/flows/" to the ID offered here.
                    
                    const fullPath = "registry/flows/" + f.id;
                    opt.value = fullPath;
                    datalist.appendChild(opt);
                });
            } catch(e) {
                console.error("Failed to load flows", e);
            }
        }
        loadFlows();

        form.onsubmit = async (e) => {
            e.preventDefault();
            const flowPath = document.getElementById('flowPath').value;
            const fileInput = document.getElementById('inputFile');
            const infoText = document.getElementById('inputText').value;

            if (!fileInput.files[0] && !infoText.trim()) {
                alert("Please select a file OR enter text.");
                return;
            }

            const formData = new FormData();
            if (fileInput.files[0]) {
                formData.append("file", fileInput.files[0]);
            }
            formData.append("input_text_raw", infoText);
            formData.append("flow_path", flowPath);

            statusDiv.innerText = "Starting run...";
            logTable.innerHTML = ""; // Clear logs
            artifactList.innerHTML = "";
            stopBtn.disabled = false;

            try {
                const res = await fetch("/start_run", {
                    method: "POST",
                    body: formData
                });
                const data = await res.json();
                currentRunId = data.run_id;
                statusDiv.innerText = "Run Started: " + currentRunId;

                startStreaming(currentRunId);
                startArtifactPolling(currentRunId);

            } catch (err) {
                statusDiv.innerText = "Error: " + err.message;
            }
        };

        stopBtn.onclick = async () => {
            if (!currentRunId) return;
            stopBtn.disabled = true;
            try {
                await fetch(`/stop_run/${currentRunId}`, { method: "POST" });
                statusDiv.innerText += " (Stopping...)";
            } catch (err) {
                console.error("Stop failed", err);
            }
        };

        function startStreaming(runId) {
            const evtSource = new EventSource("/logs/" + runId);

            evtSource.onmessage = function (e) {
                try {
                    const data = JSON.parse(e.data);
                    renderLog(data);

                    if (data.event_type === "done" || data.event_type === "cancelled" || data.event_type === "error") {
                        // Don't close immediately, keep listening for trailing logs?
                        // Actually, we can close if it's done. But artifacts might still be generating.
                        // Let's keep open for a bit or just rely on 'done' signal.
                        if (data.event_type === "cancelled") {
                            evtSource.close();
                            statusDiv.innerText = "Run Cancelled.";
                            stopBtn.disabled = true;
                        }
                    }
                } catch (parseErr) {
                    // Fallback for plain text legacy
                    renderLog({ text: e.data, event_type: "info" });
                }
            };

            evtSource.onerror = function () {
                // Connection lost or closed
                // evtSource.close();
            };
        }

        function renderLog(event) {
            const row = document.createElement("tr");

            // Meta Column
            const metaTd = document.createElement("td");
            metaTd.className = "col-meta";

            let metaHtml = "";
            if (event.timestamp) metaHtml += `[${event.timestamp.split('T')[1].split('.')[0]}]<br>`;
            if (event.framework) metaHtml += `<span style="color:#666">${event.framework}</span><br>`;

            if (event.agent) {
                if (event.agent_path) {
                    metaHtml += `<a href="/cards?path=${event.agent_path}" target="_blank" class="agent-link">${event.agent}</a>`;
                } else {
                    metaHtml += `<span style="color:#aaa">${event.agent}</span>`;
                }
            }
            metaTd.innerHTML = metaHtml;

            // Content Column
            const contentTd = document.createElement("td");
            contentTd.className = "col-content";

            // Badge
            const type = event.event_type || "info";
            const badge = document.createElement("span");
            badge.className = `badge badge-${type}`;
            badge.innerText = type;
            contentTd.appendChild(badge);

            // Text
            const textSpan = document.createElement("span");
            textSpan.innerText = event.text || "";
            contentTd.appendChild(textSpan);

            // Artifact Link?
            if (event.artifact_path) {
                const link = document.createElement("a");
                link.href = `/view_artifact/${currentRunId}/${event.artifact_path}`;
                link.className = "artifact-link";
                link.target = "_blank";
                link.innerText = "[View Artifact]";
                contentTd.appendChild(link);
            }

            row.appendChild(metaTd);
            row.appendChild(contentTd);
            logTable.appendChild(row);

            // Auto scroll
            const area = document.getElementById("log-area");
            area.scrollTop = area.scrollHeight;
        }

        function startArtifactPolling(runId) {
            const interval = setInterval(async () => {
                if (currentRunId !== runId) {
                    clearInterval(interval);
                    return;
                }

                try {
                    const res = await fetch("/artifacts/" + runId);
                    const files = await res.json();

                    artifactList.innerHTML = "";
                    files.forEach(f => {
                        const li = document.createElement("li");
                        const a = document.createElement("a");
                        a.href = f.url;
                        a.innerText = f.name;
                        a.target = "_blank";
                        a.style.color = "#fa0";
                        li.appendChild(a);
                        artifactList.appendChild(li);
                    });
                } catch (e) { console.error(e); }

            }, 3000);
        }
    </script>
</body>

</html>