<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Squared Agents Shell</title>
    <script src="/auth/config.js"></script>
    <style>
        body { font-family: system-ui, sans-serif; padding: 2rem; max-width: 600px; margin: 0 auto; }
        .status { padding: 1rem; border-radius: 4px; margin-bottom: 1rem; }
        .logged-in { background-color: #e6fffa; border: 1px solid #38b2ac; }
        .logged-out { background-color: #fff5f5; border: 1px solid #fc8181; }
        .hidden { display: none; }
        button { padding: 0.5rem 1rem; cursor: pointer; font-size: 1rem; }
        pre { background: #f7fafc; padding: 1rem; overflow-x: auto; font-size: 0.8em; }
    </style>
</head>
<body>
    <h1>Squared Agents Shell</h1>
    
    <div id="statusArea" class="status logged-out">
        Status: <strong>Logged Out</strong>
    </div>

    <div id="userInfo" class="hidden">
        <p>Welcome back!</p>
        <pre id="tokenDisplay"></pre>
        <button id="signOutBtn">Sign Out</button>
    </div>

    <div id="loginArea">
        <button id="signInBtn">Sign In</button>
    </div>

    <script>
        const { COGNITO_DOMAIN, CLIENT_ID, SCOPES } = window.NS_AUTH;

        // --- PKCE Helpers ---
        function generateRandomString() {
            const array = new Uint32Array(56/2);
            window.crypto.getRandomValues(array);
            return Array.from(array, dec => ('0' + dec.toString(16)).substr(-2)).join('');
        }

        function base64UrlEncode(str) {
            return btoa(String.fromCharCode.apply(null, new Uint8Array(str)))
                .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }

        async function generateCodeChallenge(verifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(verifier);
            const digest = await window.crypto.subtle.digest('SHA-256', data);
            return base64UrlEncode(digest);
        }

        // --- Logic ---

        function updateUI() {
            const tokensStr = sessionStorage.getItem('ns_tokens');
            if (tokensStr) {
                try {
                    const tokens = JSON.parse(tokensStr);
                    // Basic JWT decode to get payload
                    const payload = JSON.parse(atob(tokens.id_token.split('.')[1]));
                    
                    document.getElementById('statusArea').className = 'status logged-in';
                    document.getElementById('statusArea').innerHTML = `Status: <strong>Logged In</strong> as ${payload.email || 'User'}`;
                    
                    document.getElementById('userInfo').classList.remove('hidden');
                    document.getElementById('loginArea').classList.add('hidden');
                    document.getElementById('tokenDisplay').textContent = JSON.stringify(payload, null, 2);
                } catch (e) {
                    console.error("Invalid token parse", e);
                    sessionStorage.removeItem('ns_tokens');
                }
            } else {
                document.getElementById('statusArea').className = 'status logged-out';
                document.getElementById('statusArea').innerHTML = 'Status: <strong>Logged Out</strong>';
                document.getElementById('userInfo').classList.add('hidden');
                document.getElementById('loginArea').classList.remove('hidden');
            }
        }

        async function handleLogin() {
            const state = generateRandomString();
            const codeVerifier = generateRandomString(); // Simple random string is enough for verifier, but let's make it robust
            // Actually verifier needs high entropy.
            const array = new Uint8Array(32);
            window.crypto.getRandomValues(array);
            const codeVerifierRobust = base64UrlEncode(array);

            await window.sessionStorage.setItem('ns_code_verifier', codeVerifierRobust);
            const codeChallenge = await generateCodeChallenge(codeVerifierRobust);

            const params = new URLSearchParams({
                client_id: CLIENT_ID,
                response_type: 'code',
                scope: SCOPES.join(' '),
                redirect_uri: window.location.origin + '/auth/callback.html',
                state: state,
                code_challenge: codeChallenge,
                code_challenge_method: 'S256'
            });

            window.location.href = `${COGNITO_DOMAIN}/oauth2/authorize?${params.toString()}`;
        }

        document.getElementById('signInBtn').onclick = handleLogin;
        
        document.getElementById('signOutBtn').onclick = () => {
            window.location.href = '/auth/logout.html';
        };

        // Init
        updateUI();
    </script>
</body>
</html>
